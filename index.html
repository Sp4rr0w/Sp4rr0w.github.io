<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon3.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.png?v=5.1.4" color="#222">





  <meta name="keywords" content="Wind, Sparrow" />





  <link rel="alternate" href="/atom.xml" title="一 只 麻 雀" type="application/atom+xml" />






<meta name="description" content="唯有时间不可挡">
<meta property="og:type" content="website">
<meta property="og:title" content="一 只 麻 雀">
<meta property="og:url" content="https://sp4rr0w.github.io/index.html">
<meta property="og:site_name" content="一 只 麻 雀">
<meta property="og:description" content="唯有时间不可挡">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一 只 麻 雀">
<meta name="twitter:description" content="唯有时间不可挡">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://sp4rr0w.github.io/"/>





  <title>一 只 麻 雀</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一 只 麻 雀</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2019/12/04/Windows 身份验证体系结构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/04/Windows 身份验证体系结构/" itemprop="url">Windows身份验证体系结构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-04T14:55:00-05:00">
                2019-12-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/04/Windows 身份验证体系结构/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/12/04/Windows 身份验证体系结构/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/12/04/Windows 身份验证体系结构/" class="leancloud_visitors" data-flag-title="Windows身份验证体系结构">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          
            <h1 id="Windows-身份验证体系结构"><a href="#Windows-身份验证体系结构" class="headerlink" title="Windows 身份验证体系结构"></a>Windows 身份验证体系结构</h1><p><a href="https://docs.microsoft.com/zh-cn/windows-server/security/windows-authentication/windows-authentication-architecture" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/windows-server/security/windows-authentication/windows-authentication-architecture</a></p>
<p>身份验证是指系统验证用户的登录或登录信息时所使用的过程。 用户的名称和密码与授权列表进行比较，如果系统检测到匹配项，则将访问权限授予该用户的权限列表中指定的范围。</p>
<p>作为可扩展体系结构的一部分，Windows Server 操作系统将实现一组默认身份验证安全支持提供程序(SSP)，其中包括 Negotiate、Kerberos 协议、NTLM、Schannel （安全通道）和Digest(摘要)。 </p>
<p>这些提供程序使用的协议允许用户、计算机和服务进行身份验证，并且身份验证过程使授权的用户和服务能够安全地访问资源。</p>
<h2 id="本地安全机构-LSA"><a href="#本地安全机构-LSA" class="headerlink" title="本地安全机构 LSA"></a>本地安全机构 LSA</h2><p>本地安全机构（LSA）是一个受保护的子系统，用于对用户进行身份验证并登录到本地计算机。 </p>
<p>此外，LSA 还维护有关计算机上的本地安全所有方面的信息（这些方面统称为本地安全策略）。 它还提供了用于在名称和安全标识符（Sid）之间进行转换的各种服务。</p>
<p>LSA管理本地安全策略、管理审计策略和设置、为用户生成包含SID和组权限关系的令牌。</p>
<p>LSA验证的过程: LSA通过访问本地SAM(Security Accounts Manager)数据库,可以完成本地用户的验证。</p>
<p><strong>LSA的处理流程</strong> </p>
<pre><code>1. LSA首先会把身份凭据交给SSPI,由该接口负责与Kerberos和NTLM服务沟通。
2. SSPI不能确定用户是本地登录还是域账户进行域登录。所以他会先把身份认证请求传递到Kerberos SSP。
3. Kerberos SSP会验证用户的登入目标是本地计算机还是域。如果是登录域,Kerberos SSP将继续处理。如果是本地计算机,即用户不是登录域,Kerberos SSP返回一个错误消息到SSPI,交回给GINA处理,使服务器登录不可用。
4. SSPI现在发送请求到下一个安全提供程序——NTLM。NTLM SSP会将请求交给Netlogon服务针对LSAM (Local Security Account Manager,本地安全账户管理器)数据库进行身份认证。使用NTLM SSP的身份认证过程与Windows NT系统的身份认证方法是相同的。   
</code></pre><h2 id="身份验证安全支持提供程序-SSP-amp-SSPI"><a href="#身份验证安全支持提供程序-SSP-amp-SSPI" class="headerlink" title="身份验证安全支持提供程序 SSP &amp; SSPI"></a>身份验证安全支持提供程序 SSP &amp; SSPI</h2><p>SSPI(Security Support Provider Interface) 安全支持提供接口</p>
<pre><code>是通用安全服务 API （GSSAPI）的实现，也是 Windows 定义的一套接口，此接口定义了与安全有关的功能函数， 用来获得验证、信息完整性、信息隐私等安全功能，但是没有具体的实现。
</code></pre><p>SSP(Security Support Provider)直译为安全支持提供者，又名Security Package，SSPI 的实现者，对SSPI相关功能函数的具体实现。</p>
<p>简单的理解为SSP就是一个DLL，来实现身份验证等安全功能，实现的身份验证机制是不一样的，例如：</p>
<pre><code>NTLM SSP    ( Challenge/Response 验证机制 )
Kerberos SSP    ( 基于 ticket 的身份验证机制 )
Negotiate SSP (协商安全支持提供程序)
Secure Channel (Schannel) SSP
Digest SSP (摘要式安全支持提供程序)
Credential (CredSSP 凭据安全支持提供程序 )
</code></pre><p>所以可以编写自己的 SSP，然后注册到操作系统中。例如mimikatz的SSP(mimilib.dll),通过mimilib伪造SSP记录明文密码。</p>
<pre><code>copy mimilib.dll C:\windows\System32\
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\
    Security Packages
        kerberos
        msv1_0      
        schannel
        wdigest
        tspkg
        pku2u
        mimilib.dll (编辑键Security Packages添加)
域控重启后在C:\windows\System32\可看到新生成的文件kiwissp.log (这就是记录的密码)
或者
mimikatz同时还支持通过内存更新ssp，这样就不需要重启再获取账户信息
    privilege::debug
    misc::memssp
</code></pre><p><strong>SSPI Layer</strong></p>
<p><a href="https://docs.microsoft.com/zh-cn/windows-server/security/windows-authentication/security-support-provider-interface-architecture" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/windows-server/security/windows-authentication/security-support-provider-interface-architecture</a></p>
<pre><code>Application Layer                           SSPI Layer      SSP Layer
Application  RPC                        }                   {   kerberos   
.Net Application / .Net Framework       }&lt;-&gt;     SSPI   &lt;-&gt; {   NTLM        
Internet Explorer                       }                   {   Digest
                                                            {   Schannel
                                                            {   Negotiate
                                                            {   Other
</code></pre><h3 id="msv-NTLM-SSP"><a href="#msv-NTLM-SSP" class="headerlink" title="msv - NTLM SSP"></a>msv - NTLM SSP</h3><p><a href="https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/sekurlsa/kuhl_m_sekurlsa.c" target="_blank" rel="noopener">https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/sekurlsa/kuhl_m_sekurlsa.c</a></p>
<pre><code>msv1_0.dll     身份验证包 Lists LM &amp; NTLM credential
</code></pre><p>NTLM 身份验证是 Windows msv1_0.dll 中包含的一系列身份验证协议。 </p>
<pre><code>NTLM 身份验证协议包括 LAN Manager 版本 1 和 2 以及 NTLM 版本 1 和 2。 
NTLM 身份验证协议基于质询/响应机制对用户和计算机进行身份验证，该机制向服务器或域控制器证明用户知道与帐户关联的密码。 
在使用 NTLM 协议时，每当需要新的访问令牌时，资源服务器必须执行以下操作之一来验证计算机或用户的身份：
    如果计算机或用户的帐户是域帐户，请联系域控制器的部门域认证服务来获取该帐户的域。
    如果该计算机或用户的帐户是本地帐户，请在本地帐户数据库中查找该帐户。
</code></pre><p>NTLM SSP<br>NTLM 安全支持提供程序（NTLM SSP）是安全支持提供程序接口（SSPI）使用的一种二进制消息传递协议，可用于实现 NTLM 质询-响应身份验证以及协商完整性和机密性选项。 NTLM SSP 包括 NTLM 和 NTLM 版本2（NTLMv2）身份验证协议。<br>受支持的 Windows 操作系统可将 NTLM SSP 用于以下内容：</p>
<pre><code>客户端/服务器身份验证
打印服务
使用 CIFS （SMB）进行文件访问
安全远程过程调用服务或 DCOM 服务
Location：%windir%\Windows\System32\msv1_0.dll
</code></pre><p>Microsoft为本地计算机登录提供 MSV1_0 身份验证包,不需要自定义身份验证.本地安全机构(LSA)调用MSV1_0身份验证包来处理GINA为Winlogon登录过程收集的登录数据. </p>
<p>MSV1_0程序包检查本地安全帐户管理器(SAM)数据库,以确定登录数据是否属于有效的安全主体,然后将登录尝试的结果返回给LSA.</p>
<p>MSV1_0还支持域登录. MSV1_0使用传递身份( pass-through )验证处理域登录.</p>
<pre><code>在传递身份(pass-through)验证中,MSV1_0的本地实例使用Netlogon服务来调用在域控制器上运行的MSV1_0实例.
然后,域控制器的MSV1_0实例检查域控制器的SAM数据库,并将登录结果返回到本地计算机上的MSV1_0实例. 
本地MSV1_0将登录结果转发到本地计算机上的LSA.(如果域控制器不可用,并且LSA缓存了用户证书, MSV1_0的本地实例就可以使用缓存的数据来验证登录数据.)
</code></pre><p>Authentication packages是一些执行认证检查的DLL。</p>
<pre><code>Kerberos 是用于域登陆的 Windows Authentication package.
MSV1_0是用于交互式登陆到本地计算机的 Windows Authentication package.(默认)
</code></pre><p>交互式登录 (登录本机,没有域)<br>本地计算机登录身份验证过程:</p>
<pre><code>0-&gt; 用户按下Ctrl+Alt+Del组合键，Winlogon 检测到用户按下SAS组合键，调用GINA（msgina.dll）显示登录对话框，以便输入账号密码。
1-&gt; GINA为Winlogon登录过程收集的登录数据通过 Secur32.dll 传递到LSA, LSA 使用 LsaLogonUser API 为各种各样的用户身份验证 ( LsaLogonUser 支持交互式登录 / 服务登录 / 网络登录 ).
 2-&gt; (登录本机情况下)LSA(Secur32.dll LsaLogonUser API)默认调用 MSV1_0.dll 身份验证包,将用户信息处理后生成一个密钥，同SAM数据库中存储的密钥进行对比。 
  3-&gt; 请求LSA 里面的 Samsrv.dll 向HKLM\SAM检查( 使用注册表中的 SAM 数据库进行存储,所以要通过注册表中的HKLM\SAM检查 )
   4-&gt; HKLM\SAM ( 若登陆数据是属于有效的安全主体 ) 将结果返回给 MSV1_0 .
    5-&gt; MSV1_0 为该登录用户会话生成 本地唯一标识符LUID ( locally unique identifier /SID(Security Identifier)/组SID)将结果返回给 LSA (LSASS.exe ).
     6-&gt; LSA 调用Lsass.exe来创建此登录会话,将 LUID与此会话关联起来 ,将收到的SID信息为该用户创建一个安全访问令牌 ( 用户的安全标识SID(Security Identifier)/组SID/和分配的特权(特权是由LUID 对象来标识的))
      7-&gt;  然后将令牌的句柄和登录信息发送给Winlogon，完成整个登录过程。
</code></pre><p>交互式登录 (登录本机,有域)</p>
<pre><code>若存在域,MSV1_0 使用传递身份(pass-through)验证处理域登录:
1-&gt; 本地MSV1_0 使用Netlogon服务来调用在域控制器上运行的MSV1_0.
    2-&gt; 域控制器的MSV1_0实例检查域控制器的SAM数据库(上面的3步骤),并将登录结果返回到本地计算机上的MSV1_0. 
</code></pre><p>交互式登录 (登录域)<br>    身份验证过程<br>    0-&gt; 用户按下Ctrl+Alt+Del组合键，Winlogon 检测到用户按下SAS组合键，调用GINA显示登录对话框，以便输入账号密码。<br>     1-&gt; GINA为Winlogon登录过程收集的登录数据通过 Secur32.dll 传递到LSA, LSA 使用 LsaLogonUser API 为各种各样的用户身份验证 ( LsaLogonUser 支持交互式登录 / 服务登录 / 网络登录 ).<br>      2-&gt; (登录域情况下)LSA 将请求发送给Kerberos (Kerberos.dll)身份验证,通过散列算法，将用户信息生成一个密钥，并将密钥存储在证书缓存区中。<br>       3-&gt;<br>            <code>KRB_AS_REQ (Kerberos Authentication Service Request)</code></p>
<pre><code>        1. Client-A ---------------------------------------------------------==&gt; KDC-AS (客户端执行散列运算加密一个时间戳,然后（包含用户证书）发送给身份验证服务(KDC-AS)) 此过程叫KRB_AS_REQ

        `KRB_AS_REP (Kerberos Authentication Service Response)`
        2. Client-A &lt;==--------------------------------------------------------- KDC-AS (返回TGT,KDC利用自己的密钥对请求中时间戳进行解密，若解密成功(KDC-AS检查用户的信息(登录限制.组成员身份等)并创建票据授予票据TGT，且向本地LSA请求生成一个特殊的数据PAC。返回会话密钥和TGT) 此过程叫KRB_AS_REP

        `KRB_TGS_REQ (Kerberos Ticket Granting Service Request)`
        3. Client-A ----------------------------------------------------------==&gt; KDC-TGS (Client-A使用AS返回的&quot;会话密钥&quot;构建访问特定服务的请求,再把AS返回的&quot;TGT&quot;连同请求一起发送到票据授予服务TGS) 此过程叫KRB_TGS_REP

        `KRB_TGS_REP (Kerberos Ticket Granting Service Response)`
        4. Client-A &lt;==---------------------------------------------------------- KDC-TGS (TGS解密TGT和服务请求,并向Client-A发送一个服务票据ST(Service Ticket)

        `KRB_AP_REQ (Kerberos Application Request)`
        5. Client-A ----------------------------------------------------------==&gt; Server-B (Client-A把服务票据ST中的服务器部分和请求一起发送到Server-B(Client-A要访问活动目录中的主机),远程服务器将直接接受该服务器票据,并不需要和KDC直接通信,因为该票据是用远程服务器和KDC共享的长期密钥加密过的)
</code></pre><h3 id="kerberos"><a href="#kerberos" class="headerlink" title="kerberos"></a>kerberos</h3><p>是Windows活动目录中使用的客户/服务器认证协议(windows中的认证协议有两种NTLM和Kerberos),为通信双方提供双向身份认证。</p>
<p>相互认证或请求服务的实体被称为委托人(principal)。参与的中央服务器被称为密钥分发中心(简称KDC)。</p>
<p>KDC(密钥分发中心　Key Distribution Center)有两个服务组成 : </p>
<pre><code>1. AS 身份验证服务(Authentication Server)
2. TGS 票据授予服务(Ticket Granting Server)
该认证过程的实现不依赖于主机操作系统的认证,无需基于主机地址的信任,不要求网络上所有主机的物理安全,并假定网络上传送的数据包可以被任意地读取.修改和插入数据。
在以上情况下, Kerberos 作为一种可信任的第三方认证服务,是通过传统的密码技术(如:共享密钥)执行认证服务的。
</code></pre><p>身份验证过程在上。</p>
<p>由于从 Windows 2000 开始，Kerberos 协议是默认的身份验证协议，因此所有域服务都支持 Kerberos SSP。 这些服务包括：</p>
<pre><code>使用轻型目录访问协议（LDAP） Active Directory 查询
使用远程过程调用服务的远程服务器或工作站管理
打印服务
客户端-服务器身份验证
使用服务器消息块（SMB）协议（也称为通用 Internet 文件系统或 CIFS）的远程文件访问
分布式文件系统管理和引用
Intranet 到 Internet Information Services 的身份验证（IIS）
Internet 协议安全（IPsec）的安全机构身份验证
用于域用户和计算机 Active Directory 证书服务的证书请求
</code></pre><h3 id="tspkg"><a href="#tspkg" class="headerlink" title="tspkg"></a>tspkg</h3><p>TSPKG - Terminal Services Package  身份验证提供程序<br>TSSSP - Terminal Services SSP  终端服务SSP<br>SSP - 安全支持提供程序</p>
<p>RDP SSO功能依赖于允许“凭据委派(Credential Delegation)”的 CredSSP / TSSSP / TSPKG 组件。</p>
<p><a href="https://clement.notin.org/blog/2019/07/03/credential-theft-without-admin-or-touching-lsass-with-kekeo-by-abusing-credssp-tspkg-rdp-sso/" target="_blank" rel="noopener">通过滥用CredSSP / TSPKG（RDP SSO）即凭据委派，无需管理员或通过Kekeo接触LSASS即可进行凭据盗窃</a></p>
<p>凭据委派 Allow delegating default credentials  （类似于记住远程登陆过的密码）</p>
<p>Local Computer Policy –&gt; Computer Configuration –&gt; Administrative Templates –&gt; System –&gt; Credentials Delegation<br>双击打开”Allow Delegating Saved Credentials with NTLM-only Server Authentication”， 默认是 “Not configured” 选择”Enabled”<br>单击 “Show”按钮，并输入”TERMSRV/*” 到列表中，单击OK保存。<br>同样的方法，修改如下的策略：</p>
<pre><code>Allow Delegating Saved Credentials
Allow Delegating Default Credentials with NTLM-only Server Authentication
Allow Delegating Default Credentials
</code></pre><p>tspkg.DLL: TSSSP (Terminal Services SSP)</p>
<pre><code>C:\Windows\System32\tspkg.dll - Web Service Security Package 
</code></pre><h3 id="CredSSP"><a href="#CredSSP" class="headerlink" title="CredSSP"></a>CredSSP</h3><p>配置远程登陆RDP，当选中“Network Layer Authentication”（NLA是网络级身份验证）选项时，它允许在打开图形会话之前进行身份验证。</p>
<p>凭据安全服务提供程序（CredSSP）提供启动新终端服务和远程桌面服务会话时的单一登录（SSO）用户体验。 </p>
<p>使用 CredSSP，应用程序可以根据客户端的策略，将用户的凭据从客户端计算机（通过使用客户端 SSP）委托给目标服务器（通过服务器端 SSP）。 </p>
<p>CredSSP 策略通过使用组策略进行配置，并且默认情况下禁用凭据的委派。</p>
<pre><code>位置：%windir%\Windows\System32\credssp.dll
</code></pre><h3 id="Schannel"><a href="#Schannel" class="headerlink" title="Schannel"></a>Schannel</h3><p><a href="https://docs.microsoft.com/zh-cn/windows-server/security/tls/tls-ssl-schannel-ssp-overview?redirectedfrom=MSDN" target="_blank" rel="noopener">TLS/SSL 概述（Schannel SSP）</a></p>
<p>安全通道（Schannel）用于基于 web 的服务器身份验证，例如，当用户尝试访问安全 web 服务器时。</p>
<pre><code>位置：%windir%\Windows\System32\Schannel.dll
</code></pre><p>Schannel 是安全支持提供程序 (SSP)，可实现安全套接字层 (SSL) 和传输层安全 (TLS) Internet 标准身份验证协议。</p>
<p>TLS 协议、SSL 协议、专用通信技术（PCT）协议和数据报传输层（DTLS）协议基于公钥加密。 Schannel 提供所有这些协议。所有 Schannel 协议均使用协议使用客户端/服务器模型，且基于需要公钥基础结构的证书身份验证。</p>
<p>对参与方进行身份验证时，Schannel SSP 按以下优先顺序选择协议：</p>
<pre><code>传输层安全性（TLS）版本1.0
传输层安全性（TLS）版本1.1
传输层安全性（TLS）版本1.2
安全套接字层（SSL）版本2.0
安全套接字层（SSL）版本3.0
专用通信技术（百分比,默认PCT 处于禁用状态）
</code></pre><p>选择的协议是客户端和服务器可以支持的首选身份验证协议。 例如，如果服务器支持所有 Schannel 协议，而客户端仅支持 SSL 3.0 和 SSL 2.0，则身份验证过程使用 SSL 3.0。</p>
<p>管理网络时的一个问题是保护跨未受信任的网络在应用程序之间发送的数据的安全。 </p>
<p>你可以使用 TLS 和 SSL 对服务器和客户端计算机进行身份验证，然后使用协议对经过身份验证的参与方之间的消息进行加密。<br>例如，你可以将 TLS/SSL 用于：</p>
<pre><code>电子商务网站受 SSL 保护的交易
对受 SSL 保护的网站的经身份验证的客户端访问
远程访问
SQL 访问
电子邮件
</code></pre><h3 id="WDigest"><a href="#WDigest" class="headerlink" title="WDigest"></a>WDigest</h3><p>Digest 与 NTLM 类似也一种挑战认证的协议，用于轻型目录访问协议（LDAP）和 web 身份验证(IIS)。 摘要式身份验证通过网络以 MD5 哈希或消息摘要形式传输凭据。</p>
<p>Digest SSP （Wdigest）用于以下内容：</p>
<pre><code>Internet Explorer 和 Internet Information Services （IIS）访问
LDAP 查询
位置：%windir%\Windows\System32\Digest.dll
</code></pre><p>挑战认证的基本流程就是：</p>
<pre><code>客户端访问服务端发起认证
服务端返回一个随机值
客户端利用自己知道的密码或一些其他信息来对这个随机值做一些计算，得运算结果 response，将 response 发送至服务端
服务端利用同样的方法也计算出一个 response，并将自己计算出的这个与客户端发送过来的 response 进行对比，如果一致，则证明客户端确实是知道密码，认证成功。
</code></pre><p>所以，在用户进行了交互式登陆后，为了实现 Digest 认证机制的 SSO，Digest SSP 只能将密码加密后保存在内存里面，在有任何客户端软件需要与远程服务器进行 Digest 认证的时候解密还原成明文用于计算 Digest response。</p>
<p>从 Windows 2003 开始，引入了Advanced Digest（就是 Digest 的升级版）。</p>
<p>wdigest.dll 实现的就是 Advanced digest，而不再是老的 digest 认证协议了。其中一项改变就是，它允许不再存储账号的明文密码。</p>
<p>比如域的 FQDN 为 EAST.COM，域账号为 user01，密码为 123456。那么域控并不会保存 user01 账号的明文密码 123456，而是将 MD5(user01:EAST.COM:123456) 后的29种HASH保存在域数据库中，这样就绕过了需要明文密码的问题。</p>
<p>使用 mimikatz 的 dcsync 或其他功能看到的一大堆 Wdigest 的 Hash，就是这 29 种 Hash。而如果给账号开了 Reversible Encryption ，则 dcscync 会将明文密码读出来</p>
<p>Reversible Encryption （可逆加密）</p>
<p>默认情况下，域里的所有账号都是关闭这个功能的（在没有 Advanced digest 的时候，关闭了这个功能的域账号将不能使用 digest 进行认证）。所以，域数据库里面默认只保存了密码的 Hash 而没有保存密码本身。</p>
<p>开启 Reversible Encryption 的三种方法：</p>
<pre><code>在域控的组策略里面对所有域成员开启，此时除了 HASH 外，所有域成员的明文密码都会以一种可逆加密的形式保存在域数据库中。以可逆加密形式存储的明文密码，跟直接存储明文没有什么区别。（Group Policy -&gt; Computer Configuration -&gt; Policies -&gt; Windows Settings -&gt; Security Settings -&gt; Account Policies -&gt; Store password using Reversible Encryption √ )

在域用户管理里面，单独为某些用户启用 Reversible Encryption 功能。启动了此功能的用户会在它们的 UserAccessControl 属性里面留下标志。（右键用户属性-&gt; Account -&gt; Store password using Reversible Encryption √ )

利用多元密码策略（Fine-Grained Password Policies）启用 (Windows Server 2008 or higher)

[Dump Clear-Text Passwords for All Admins in the Domain Using Mimikatz DCSync](https://adsecurity.org/?p=2053)
</code></pre><p>禁用WDigest</p>
<pre><code>HKLM\System\CurrentControl\SetControl\LsaSecurityPack中删除WDigest，然后重新启动服务器 (Windows Server 2008)
HKLM\System\CurrentControlSet\Control\SecurityProviders\WDigest中创建/设置UseLogonCredential= dword：00000000 (要明文形式保存在 LSA 内存中则设为1)
Windows Server 2012 R2-2016：默认情况下禁用WDigest，不执行任何操作
</code></pre><p>Mimikatz中sekurlsa::wdigest 实现思路</p>
<pre><code>1.提升至Debug权限。
2.获得lsass进程句柄。
3.枚举lsass进程中全部模块的句柄，定位wdigest.dll和lsasrv.dll在内存中的位置。
4.从lsasrv.dll中获得InitializationVector，AES和3DES的值，用于解密。
5.从wdigest.dll中获得每条凭据的信息，判断加密算法，解密获得明文口令。
(Windows Server 2008 R2及更高版本的系统需要修改注册表)
位置：%windir%\Windows\System32\kerberos.dll
</code></pre><h3 id="Negotiate-SPNEGO"><a href="#Negotiate-SPNEGO" class="headerlink" title="Negotiate - SPNEGO"></a>Negotiate - SPNEGO</h3><p>简单且受保护的 GSS-API 协商机制（ SPNEGO ）构成协商 SSP 的基础，whichcan 用于协商特定身份验证协议。</p>
<p>当应用程序调用 SSPI 登录到网络时，它可以指定 SSP 来处理请求。 如果应用程序指定 Negotiate SSP，则它会分析请求，并根据客户配置的安全策略选择相应的提供程序来处理请求。</p>
<p>在支持的 Windows 操作系统版本中，协商安全支持提供程序在 Kerberos 协议和 NTLM 之间选择。 </p>
<p>默认情况下，协商将选择 Kerberos 协议，除非该协议不能由身份验证中涉及的系统之一使用，或调用应用程序没有提供足够的信息来使用 Kerberos 协议。</p>
<pre><code>位置：%windir%\Windows\System32\lsasrv.dll
</code></pre><h3 id="PKU2U"><a href="#PKU2U" class="headerlink" title="PKU2U"></a>PKU2U</h3><p>Windows 7 和 Windows Server 2008 R2 中引入了 PKU2U 协议，并将其作为 SSP 实现。 </p>
<p>此 SSP 启用对等身份验证，特别是在 Windows 7 中引入了名为 “家庭组” 的媒体和文件共享功能。 此功能允许在非域成员的计算机之间共享。</p>
<pre><code>位置：%windir%\Windows\System32\pku2u.dll
</code></pre><h3 id="Exchange-认证"><a href="#Exchange-认证" class="headerlink" title="Exchange 认证"></a>Exchange 认证</h3><p>身份验证是 Exchange Web Services (EWS) 应用程序的关键部分。</p>
<p><a href="https://docs.microsoft.com/zh-cn/exchange/client-developer/exchange-web-services/authentication-and-ews-in-exchange" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/exchange/client-developer/exchange-web-services/authentication-and-ews-in-exchange</a></p>
<p>Exchange 提供以下身份验证选项：</p>
<pre><code>OAuth 2.0 (Exchange Online 仅 ， OAuth2.0应用于Office 365应用程序接口)
NTLM （Exchange 内部部署仅）
Basic （基本身份验证 - 不再推荐）
</code></pre><h2 id="Windows-身份验证中的凭据进程"><a href="#Windows-身份验证中的凭据进程" class="headerlink" title="Windows 身份验证中的凭据进程"></a>Windows 身份验证中的凭据进程</h2><p>Windows 凭据管理是操作系统从<strong>服务或用户接收凭据</strong>的过程，并保护该信息以供将来呈现到身份验证目标。 </p>
<p>对于已加入域的计算机，身份验证目标为域控制器。身份验证中使用的凭据是将用户标识关联到某种形式的身份验证（如证书、密码或 PIN）的数字文档。</p>
<p>默认情况下，将根据本地计算机上的安全帐户管理器（SAM）数据库或通过 Winlogon 服务在加入域的计算机上 Active Directory 验证 Windows 凭据。 </p>
<p>凭据是通过登录用户界面上的用户输入收集的，也可以通过应用程序编程接口（API）以编程方式通过向身份验证目标提供。</p>
<p>本地安全信息存储在HKEY_LOCAL_MACHINE\SECURITY下的注册表中。 存储的信息包括策略设置、默认安全值和帐户信息，如缓存的登录凭据。 SAM 数据库的副本也存储在此处，尽管它是写保护的。</p>
<p><a href="https://docs.microsoft.com/zh-cn/windows-server/security/media/credentials-processes-in-windows-authentication/authn_lsa_architecture_client.gif" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/windows-server/security/media/credentials-processes-in-windows-authentication/authn_lsa_architecture_client.gif</a></p>
<h2 id="Windows-身份验证中使用的组策略设置"><a href="#Windows-身份验证中使用的组策略设置" class="headerlink" title="Windows 身份验证中使用的组策略设置"></a>Windows 身份验证中使用的组策略设置</h2><p><a href="https://docs.microsoft.com/zh-cn/windows-server/security/windows-authentication/group-policy-settings-used-in-windows-authentication" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/windows-server/security/windows-authentication/group-policy-settings-used-in-windows-authentication</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/07/07/PowerShell Tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/07/PowerShell Tips/" itemprop="url">PowerShell Tips</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-07T14:08:04-04:00">
                2018-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/07/PowerShell Tips/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/07/PowerShell Tips/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/07/PowerShell Tips/" class="leancloud_visitors" data-flag-title="PowerShell Tips">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          <h2 id="0x01-PowerShell条件判断"><a href="#0x01-PowerShell条件判断" class="headerlink" title="0x01 PowerShell条件判断"></a>0x01 PowerShell条件判断</h2><p>PowerShell Switch 条件<br>如果语句中有多路分支,使用IF-ELSEIF-ELSE不友好,可以使用Switch,看起来比较清爽一点。<br>下面的例子将If-ElseIF-Else转换成Switch语句</p>
<pre><code># 使用 IF-ElseIF-Else
If( $value -eq 1 )
{
    &quot;Beijing&quot;
}
Elseif( $value -eq 2)
{
    &quot;Shanghai&quot;
}
Else
{
    &quot;Chongqing&quot;
}

# 使用 Switch
switch($value)
{
    1 {&quot;Beijing&quot;}
    2 {&quot;Shanghai&quot;}
    3 {&quot;Chongqing&quot;}
}
</code></pre>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/07/07/PowerShell Tips/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/07/05/PowerShell 基础总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/05/PowerShell 基础总结/" itemprop="url">PowerShell 基础总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-05T20:08:00-04:00">
                2018-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/05/PowerShell 基础总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/05/PowerShell 基础总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/05/PowerShell 基础总结/" class="leancloud_visitors" data-flag-title="PowerShell 基础总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          <h2 id="0x01-PowerShell简介及特性"><a href="#0x01-PowerShell简介及特性" class="headerlink" title="0x01 PowerShell简介及特性"></a>0x01 PowerShell简介及特性</h2><p>Windows PowerShell 是一种命令行外壳程序和脚本环境(相当于 UNIX 系统 BASH),使命令行用户和脚本编写者可以利用.NET Framework的强大功能(因此也支持.NET对象)。<br>Windows PowerShell具备以下特性:</p>
<pre><code>操作便捷—-可识别单位(如GB、MB、KB等)Cmdlet命令结构简单(动名词形式)
面向对象—-同面向过程相比,更容易描述现实事物
结合.NET Framework环境—-借助.NET Framework平台的强大的库
兼容性强—-完全兼容windows平台上其他调用,如exe文件执行、bat脚本执行等
基于平台的可扩展性—-PowerShell俨然已形成一个平台,并且向各类平台管理提供对应管理组件
</code></pre><p>PowerShell Version<br><img src="/2018/07/05/PowerShell 基础总结/ps-version.png" alt="ps-version"></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/07/05/PowerShell 基础总结/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/06/30/ElasticSearch学习总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/30/ElasticSearch学习总结/" itemprop="url">ElasticSearch学习总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-30T15:10:30-04:00">
                2018-06-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/30/ElasticSearch学习总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/06/30/ElasticSearch学习总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/06/30/ElasticSearch学习总结/" class="leancloud_visitors" data-flag-title="ElasticSearch学习总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          <h2 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h2><pre><code>ElasticSearch是一个分布式、Restful的搜索及分析服务器,设计用于分布式计算；能够达到实时搜索,稳定,可靠,快速。
和Apache Solr一样,它也是基于Lucence的索引服务器。2013年初,GitHub抛弃了Solr,采取ElasticSearch 来做PB级的搜索
</code></pre>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/06/30/ElasticSearch学习总结/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/05/30/Outlook Homepage Vulner/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/Outlook Homepage Vulner/" itemprop="url">Outlook Homepage Vulner</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-30T19:28:00-04:00">
                2018-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/30/Outlook Homepage Vulner/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/05/30/Outlook Homepage Vulner/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/05/30/Outlook Homepage Vulner/" class="leancloud_visitors" data-flag-title="Outlook Homepage Vulner">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          <h2 id="0x00-环境介绍"><a href="#0x00-环境介绍" class="headerlink" title="0x00 环境介绍"></a>0x00 环境介绍</h2><p>域控制器 ： OWA2013DC - 10.1.0.100   域名：corp.contoso.com</p>
<p>Exchange服务器 ： OWA2013Server - 10.1.0.213    加入域</p>
<p>Kali ： 10.1.0.166   未加入域</p>
<p>虚拟机模式: hostonly</p>
<p>三台网关:10.1.0.100 </p>
<p>hosts: 10.1.0.213    corp.contoso.com    contoso.com        autodiscover.contoso.com</p>
<p><code>CVE-2017-11774</code></p>
<pre><code>https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11774 
</code></pre><p><code>Description</code></p>
<pre><code>Microsoft Outlook 2010 SP2, Outlook 2013 SP1 and RT SP1, and Outlook 2016 allow an attacker to execute arbitrary commands, due to how Microsoft Office handles objects in memory, aka &quot;Microsoft Outlook Security Feature Bypass Vulnerability.&quot;
</code></pre>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/05/30/Outlook Homepage Vulner/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/04/11/搭建私有Tor网络/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/11/搭建私有Tor网络/" itemprop="url">搭建私有Tor网络</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-11T19:58:00-04:00">
                2018-04-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/11/搭建私有Tor网络/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/04/11/搭建私有Tor网络/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/04/11/搭建私有Tor网络/" class="leancloud_visitors" data-flag-title="搭建私有Tor网络">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          <h2 id="0x00-搭建私有Tor网络-private-Tor-network"><a href="#0x00-搭建私有Tor网络-private-Tor-network" class="headerlink" title="0x00 搭建私有Tor网络 ( private Tor network)"></a>0x00 搭建私有Tor网络 ( private Tor network)</h2><p>RS1 ： Tor Client (客户端)    </p>
<p>RS2 ： Tor relay    (退出及中继节点)    2个中继+1退出中继</p>
<p>RS3 ： Tor Bridge relay    (网桥)    </p>
<p>RS4 ： Authority Server (权威目录服务器)</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/04/11/搭建私有Tor网络/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/04/07/Tor技术相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/07/Tor技术相关/" itemprop="url">Tor技术相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-07T11:58:00-04:00">
                2018-04-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/07/Tor技术相关/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/04/07/Tor技术相关/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/04/07/Tor技术相关/" class="leancloud_visitors" data-flag-title="Tor技术相关">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          <h2 id="0x01-Tor的工作原理"><a href="#0x01-Tor的工作原理" class="headerlink" title="0x01 Tor的工作原理"></a>0x01 Tor的工作原理</h2><p>基于TCP连接的匿名通信系统,它可以用于网页浏览、即时消息等通信。</p>
<p>它首先从目录服务器(Directory Server,DS)中获得所有Tor节点信息,然后在Tor节点集合中随机选取一个节点,与它协商密钥,最后与它建立一个安全信道。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/04/07/Tor技术相关/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/03/28/批量导出ElasticSearch查询的结果/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/28/批量导出ElasticSearch查询的结果/" itemprop="url">批量导出ElasticSearch查询的结果</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-28T16:09:00-04:00">
                2018-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/28/批量导出ElasticSearch查询的结果/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/28/批量导出ElasticSearch查询的结果/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/03/28/批量导出ElasticSearch查询的结果/" class="leancloud_visitors" data-flag-title="批量导出ElasticSearch查询的结果">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          <p>…..<br></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/03/28/批量导出ElasticSearch查询的结果/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/02/19/域渗透相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/19/域渗透相关/" itemprop="url">域渗透相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-19T08:10:00-05:00">
                2018-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/19/域渗透相关/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/02/19/域渗透相关/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/19/域渗透相关/" class="leancloud_visitors" data-flag-title="域渗透相关">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          <p>…..<br></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/02/19/域渗透相关/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sp4rr0w.github.io/2018/02/18/Kerberos认证相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jacksparrow.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一 只 麻 雀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/18/Kerberos认证相关/" itemprop="url">Kerberos认证相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-18T19:09:00-05:00">
                2018-02-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术相关/" itemprop="url" rel="index">
                    <span itemprop="name">技术相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/18/Kerberos认证相关/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/02/18/Kerberos认证相关/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/02/18/Kerberos认证相关/" class="leancloud_visitors" data-flag-title="Kerberos认证相关">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
   <!-- 文章摘要图片 -->

   <!-- 文章摘要图片 -->
        
          <h2 id="0x01-Kerberos认证过程-简易版"><a href="#0x01-Kerberos认证过程-简易版" class="headerlink" title="0x01 Kerberos认证过程 (简易版)"></a>0x01 Kerberos认证过程 (简易版)</h2><p>认证或请求服务 的过程如下:<br><img src="/2018/02/18/Kerberos认证相关/simple.jpg" alt="认证或请求服务"></p>
<p><code>简义</code></p>
<pre><code>`KRB_AS_REQ (Kerberos Authentication Service Request)`
1. Client-A ---------------------------------------------------------==&gt; KDC-AS (客户端执行散列运算加密一个时间戳,然后发送给身份验证服务(KDC-AS)) 此过程叫KRB_AS_REQ


`KRB_AS_REP (Kerberos Authentication Service Response)`
2. Client-A &lt;==--------------------------------------------------------- KDC-AS (返回TGT,TGT票据使用KDC的krbtgt密钥进行加密) 此过程叫KRB_AS_REP


`KRB_TGS_REQ (Kerberos Ticket Granting Service Request)`
3. Client-A ----------------------------------------------------------==&gt; KDC-TGS (Client-A使用AS返回的&quot;会话密钥&quot;构建访问特定服务的请求,再把AS返回的&quot;TGT&quot;连同请求一起发送到票据授予服务TGS) 此过程叫KRB_TGS_REP


`KRB_TGS_REP (Kerberos Ticket Granting Service Response)`
4. Client-A &lt;==---------------------------------------------------------- KDC-TGS (TGS解密TGT和服务请求,并向Client-A发送一个服务票据ST(Service Ticket)


`KRB_AP_REQ (Kerberos Application Request)`
5. Client-A ----------------------------------------------------------==&gt; Server-B (Client-A把服务票据中的服务器部分和请求一起发送到Server-B(Client-A要访问活动目录中的主机),远程服务器将直接接受该服务器票据,并不需要和KDC直接通信,因为该票据是用远程服务器和KDC共享的长期密钥加密过的)
</code></pre>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/02/18/Kerberos认证相关/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/jacksparrow.png"
                alt="Sparrow" />
            
              <p class="site-author-name" itemprop="name">Sparrow</p>
              <p class="site-description motion-element" itemprop="description">唯有时间不可挡</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xxxxxxxxxxxxxxxxxxxx" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:3sparrow@protonmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                有趣的人
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/xxxxxxxxxxxxxxxxxxxxxxxxxx" title="以前的CSDN" target="_blank">以前的CSDN</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.c0smx.com/" title="dalao c0sMx" target="_blank">dalao c0sMx</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://riesa.me/" title="dalao riesa" target="_blank">dalao riesa</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://zeringzxh.github.io/" title="zering" target="_blank">zering</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sparrow</span>

  
</div>






  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'XzzzFqxY7zSnAm9am6FHg6do-gzGzoHsz',
        appKey: 'aaBboz6UbNeJnPowxKNNDTm2',
        placeholder: 'Just go go',
        avatar:'wavatar',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("XzzzFqxY7zSnAm9am6FHg6do-gzGzoHsz", "aaBboz6UbNeJnPowxKNNDTm2");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
